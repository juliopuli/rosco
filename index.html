<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra Online Sincronizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: #050510; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        /* Menús */
        .card { background: #16213e; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 400px; width: 100%; margin-top: 50px; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #1f4068; background: #0a192f; color: white; width: 80%; margin: 10px 0; font-size: 1.1em; text-align: center; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; margin: 5px; transition: 0.3s; }
        .btn-main { background: #2ecc71; color: white; width: 100%; }
        .btn-sec { background: #0044cc; color: white; width: 100%; }
        
        /* Juego */
        #juego { display: none; width: 100%; justify-content: space-around; align-items: flex-start; margin-top: 20px; }
        .rosco-side { display: flex; flex-direction: column; align-items: center; width: 350px; }
        .rosco-container { position: relative; width: 320px; height: 320px; margin: 20px; }
        .letra { position: absolute; width: 26px; height: 26px; background: #0044cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid white; transform: translate(-50%, -50%); font-size: 11px; }
        .activa { border: 3px solid #f1c40f; scale: 1.3; box-shadow: 0 0 15px #f1c40f; z-index: 10; }
        .acierto { background: #2ecc71 !important; }
        .fallo { background: #e74c3c !important; }

        #panel-central { width: 400px; background: #16213e; padding: 20px; border-radius: 15px; text-align: center; }
        .turno-tag { padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; display: inline-block; }
        .mi-turno { background: #2ecc71; color: #050510; }
        .su-turno { background: #e74c3c; color: white; }
        
        .hidden { display: none; }
        #copy-code { background: #34495e; color: #ecf0f1; padding: 10px; border-radius: 5px; cursor: pointer; font-family: monospace; }
    </style>
</head>
<body>

    <div id="menu-inicial" class="card">
        <h1>PASAPALABRA</h1>
        <button class="btn-main" onclick="iniciarModo('local')">MODO LOCAL</button>
        <button class="btn-sec" onclick="mostrarMenuOnline()">MODO ONLINE</button>
    </div>

    <div id="menu-online" class="card hidden">
        <div id="paso-1">
            <button class="btn-main" onclick="generarCodigoPartida()">GENERAR CÓDIGO</button>
            <p>o</p>
            <input type="text" id="input-unirse" placeholder="Pega el código aquí">
            <button class="btn-sec" onclick="unirseAPartida()">UNIRSE A PARTIDA</button>
        </div>
        
        <div id="esperando" class="hidden">
            <h3>Código de tu sala:</h3>
            <div id="copy-code" onclick="copiarCodigo()">---</div>
            <p>Pásale este código a tu amigo. <br> Esperando conexión...</p>
        </div>
    </div>

    <div id="juego">
        <div class="rosco-side">
            <h3 id="label-j1">TÚ</h3>
            <div id="rosco1" class="rosco-container"></div>
        </div>

        <div id="panel-central">
            <div id="badge-turno" class="turno-tag">Cargando...</div>
            <p id="pregunta-txt">Esperando al otro jugador...</p>
            <div id="controles">
                <input type="text" id="ans" placeholder="Escribe..." autocomplete="off">
                <br>
                <button class="btn-main" onclick="procesarAccion('ok')">RESPONDER</button>
                <button class="btn-sec" onclick="procesarAccion('paso')" style="background:#f1c40f; color:black">PASAPALABRA</button>
            </div>
        </div>

        <div class="rosco-side">
            <h3 id="label-j2">RIVAL</h3>
            <div id="rosco2" class="rosco-container"></div>
        </div>
    </div>

    <script>
        let client, salaID, miRol; 
        let miTurno = false;
        let preguntas = [];
        let idxJ1 = 0, idxJ2 = 0;
        let estadosJ1 = [], estadosJ2 = [];

        // 1. NAVEGACIÓN
        function mostrarMenuOnline() {
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('menu-online').classList.remove('hidden');
        }

        // 2. GENERAR CÓDIGO (HOST)
        function generarCodigoPartida() {
            salaID = Math.random().toString(36).substring(2, 8).toUpperCase();
            miRol = 'host';
            miTurno = true;
            document.getElementById('copy-code').innerText = salaID;
            document.getElementById('paso-1').classList.add('hidden');
            document.getElementById('esperando').classList.remove('hidden');
            conectarMQTT();
        }

        // 3. UNIRSE (GUEST)
        function unirseAPartida() {
            salaID = document.getElementById('input-unirse').value.trim().toUpperCase();
            if(!salaID) return alert("Introduce un código");
            miRol = 'guest';
            miTurno = false;
            conectarMQTT();
        }

        // 4. MQTT LOGIC
        function conectarMQTT() {
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "pasa_" + Math.random());
            client.onMessageArrived = manejarMensaje;
            client.connect({ onSuccess: () => {
                client.subscribe("pasa/sala/" + salaID);
                if(miRol === 'host') {
                    // El host carga las preguntas y espera al invitado
                    prepararPreguntasHost();
                } else {
                    // El invitado avisa que entró
                    enviarMsg({ tipo: 'JOIN' });
                }
            }});
        }

        async function prepararPreguntasHost() {
            const res = await fetch('preguntas.json');
            preguntas = await res.json();
            estadosJ1 = new Array(preguntas.length).fill('pendiente');
            estadosJ2 = new Array(preguntas.length).fill('pendiente');
        }

        function enviarMsg(obj) {
            const message = new Paho.MQTT.Message(JSON.stringify(obj));
            message.destinationName = "pasa/sala/" + salaID;
            client.send(message);
        }

        function manejarMensaje(msg) {
            const data = JSON.parse(msg.payloadString);

            if(data.tipo === 'JOIN' && miRol === 'host') {
                // Invitado entró: El host le manda las preguntas
                enviarMsg({ tipo: 'START', preguntas: preguntas });
                empezarJuego();
            }

            if(data.tipo === 'START' && miRol === 'guest') {
                preguntas = data.preguntas;
                estadosJ1 = new Array(preguntas.length).fill('pendiente');
                estadosJ2 = new Array(preguntas.length).fill('pendiente');
                empezarJuego();
            }

            if(data.tipo === 'ACCION') {
                if(data.player !== miRol) {
                    actualizarEstadoRival(data);
                }
            }
        }

        // 5. LÓGICA DE JUEGO
        function empezarJuego() {
            document.getElementById('menu-online').classList.add('hidden');
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('juego').style.display = 'flex';
            dibujarRoscos();
            actualizarUI();
        }

        function dibujarRoscos() {
            renderRosco('rosco1', estadosJ1, (miRol === 'host' ? idxJ1 : idxJ2)); 
            renderRosco('rosco2', estadosJ2, (miRol === 'host' ? idxJ2 : idxJ1));
        }

        function renderRosco(id, estados, activoIdx) {
            const cont = document.getElementById(id);
            cont.innerHTML = "";
            estados.forEach((est, i) => {
                const ang = (i * (360 / 24)) - 90;
                const rad = ang * Math.PI / 180;
                const div = document.createElement('div');
                div.className = `letra ${est} ${i === activoIdx ? 'activa' : ''}`;
                div.style.left = (160 + 140 * Math.cos(rad)) + 'px';
                div.style.top = (160 + 140 * Math.sin(rad)) + 'px';
                div.innerText = preguntas[i].letra;
                cont.appendChild(div);
            });
        }

        function actualizarUI() {
            const badge = document.getElementById('badge-turno');
            badge.innerText = miTurno ? "ES TU TURNO" : "TURNO RIVAL";
            badge.className = "turno-tag " + (miTurno ? "mi-turno" : "su-turno");
            
            const pIdx = (miRol === 'host' ? idxJ1 : idxJ2);
            const p = preguntas[pIdx];
            document.getElementById('pregunta-txt').innerText = `${p.tipo} ${p.letra}: ${p.pregunta}`;
            document.getElementById('controles').style.opacity = miTurno ? "1" : "0.3";
            document.getElementById('ans').disabled = !miTurno;
        }

        function procesarAccion(tipo) {
            if(!miTurno) return;
            const input = document.getElementById('ans');
            const pIdx = (miRol === 'host' ? idxJ1 : idxJ2);
            let res = 'pendiente';

            if(tipo === 'ok') {
                const user = input.value.toLowerCase().trim();
                const target = preguntas[pIdx].respuesta.toLowerCase();
                // Aquí podrías meter tu lógica de Levenshtein
                if(user === target) {
                    res = 'acierto';
                } else {
                    res = 'fallo';
                    miTurno = false;
                }
            } else {
                miTurno = false; // Pasapalabra cambia turno
            }

            if(miRol === 'host') { estadosJ1[pIdx] = res; if(res !== 'acierto') miTurno = false; }
            else { estadosJ2[pIdx] = res; if(res !== 'acierto') miTurno = false; }

            enviarMsg({ tipo: 'ACCION', player: miRol, idx: pIdx, res: res });
            
            if(res !== 'pendiente') avanzarIdx();
            input.value = "";
            dibujarRoscos();
            actualizarUI();
        }

        function actualizarEstadoRival(data) {
            if(data.player === 'host') {
                estadosJ1[data.idx] = data.res;
            } else {
                estadosJ2[data.idx] = data.res;
            }
            if(data.res !== 'acierto') miTurno = true;
            dibujarRoscos();
            actualizarUI();
        }

        function avanzarIdx() {
            if(miRol === 'host') {
                do { idxJ1 = (idxJ1 + 1) % 24; } while(estadosJ1[idxJ1] !== 'pendiente');
            } else {
                do { idxJ2 = (idxJ2 + 1) % 24; } while(estadosJ2[idxJ2] !== 'pendiente');
            }
        }

        function copiarCodigo() {
            navigator.clipboard.writeText(salaID);
            alert("Código copiado: " + salaID);
        }
    </script>
</body>
</html>
