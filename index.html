<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra Final</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --fondo: #050a1f; --panel: #111b3d; --oro: #ffcc00; --verde: #2ecc71; --rojo: #dc3545; --azul-letra: #0044ff; }
        body { background: var(--fondo); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .oculto { display: none !important; }

        /* Estilo de las Ventanas (Menús) */
        .pantalla { text-align: center; background: var(--panel); padding: 40px; border-radius: 20px; border: 1px solid #2a3a6d; width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; z-index: 100; }
        h1, h2 { color: var(--oro); margin-top: 0; }
        
        input { width: 80%; padding: 15px; margin: 15px 0; border-radius: 10px; border: none; font-size: 1.1rem; text-align: center; outline: none; }
        
        .btn { width: 100%; padding: 15px; margin: 10px 0; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 1rem; transition: 0.2s; }
        .btn:hover { transform: scale(1.02); }
        .btn-green { background: var(--verde); color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn-orange { background: #e67e22; color: white; }

        /* Estilo del Juego */
        #tablero-juego { display: none; width: 100vw; height: 100vh; position: relative; }
        
        /* Jugador Principal (Grande) */
        .jugador-main { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 550px; height: 550px; border-radius: 50%; border: 3px solid var(--oro); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.5s; background: rgba(17, 27, 61, 0.95); }
        
        /* Jugador Rival (Pequeño - Solo en modo Online) */
        .jugador-rival { position: absolute; top: 20px; right: 20px; width: 180px; height: 180px; border-radius: 50%; border: 2px solid #555; transform: scale(0.8); opacity: 0.8; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--panel); transition: all 0.5s; }

        /* El Rosco */
        .rosco-container { position: relative; width: 100%; height: 100%; }
        
        .letra { position: absolute; width: 38px; height: 38px; background: var(--azul-letra); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; font-size: 18px; z-index: 10; }
        
        /* Ajuste para el rival pequeño */
        .jugador-rival .letra { width: 12px; height: 12px; font-size: 0; border: 1px solid #ccc; }

        /* Estados de colores */
        .bien { background: var(--verde) !important; border-color: white; }
        .mal { background: var(--rojo) !important; border-color: white; }
        .actual { background: var(--oro) !important; color: black; box-shadow: 0 0 20px var(--oro); transform: scale(1.3); z-index: 20; }

        /* Controles dentro del rosco */
        .centro-mando { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 70%; }
        .jugador-rival .centro-mando { display: none; } /* Ocultar controles del rival */

        .pregunta { font-size: 1.2rem; min-height: 60px; margin-bottom: 10px; font-weight: bold; text-shadow: 1px 1px 2px black; }
        .btn-juego { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }

    </style>
</head>
<body>

    <div id="pantalla-nombre" class="pantalla">
        <h1>PASAPALABRA</h1>
        <p>Introduce tu nombre para empezar</p>
        <input type="text" id="input-nombre" placeholder="Nombre de usuario">
        <button class="btn btn-green" onclick="irAModos()">CONTINUAR</button>
    </div>

    <div id="pantalla-modos" class="pantalla oculto">
        <h2 id="saludo-titulo">HOLA</h2>
        <p>¿Cómo quieres jugar?</p>
        <button class="btn btn-purple" onclick="modoSolo()">JUGAR SOLO (LOCAL)</button>
        <button class="btn btn-blue" onclick="irAOnline()">JUGAR ONLINE (2 JUGADORES)</button>
    </div>

    <div id="pantalla-online-opciones" class="pantalla oculto">
        <h2>ONLINE</h2>
        <button class="btn btn-orange" onclick="pantallaGenerar()">GENERAR CÓDIGO (HOST)</button>
        <button class="btn btn-green" onclick="pantallaUnirse()">UNIRSE CON CÓDIGO</button>
        <br><br>
        <button class="btn" style="background:#555; color:white" onclick="volverAModos()">ATRÁS</button>
    </div>

    <div id="pantalla-host" class="pantalla oculto">
        <h3>TU CÓDIGO DE SALA:</h3>
        <h1 id="codigo-mostrado" style="font-size: 3rem; letter-spacing: 5px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;">...</h1>
        <p>Comparte este código con tu amigo.</p>
        <p id="estado-host" style="color: yellow; font-style: italic;">Esperando conexión...</p>
    </div>

    <div id="pantalla-guest" class="pantalla oculto">
        <h3>INTRODUCE EL CÓDIGO:</h3>
        <input type="text" id="input-codigo" placeholder="Ej: 123456" maxlength="6">
        <button class="btn btn-green" onclick="conectarHost()">ENTRAR A LA SALA</button>
        <p id="estado-guest" style="color: yellow; font-style: italic;"></p>
        <button class="btn" style="background:#555; color:white" onclick="volverAOnline()">ATRÁS</button>
    </div>

    <div id="tablero-juego">
        <div id="jugador-yo" class="jugador-main">
            <div id="rosco-yo" class="rosco-container"></div>
            <div class="centro-mando">
                <h2 id="mi-nick" style="margin:0; color:var(--oro)">YO</h2>
                <div id="pregunta-texto" class="pregunta">Cargando...</div>
                <input type="text" id="respuesta-input" placeholder="Respuesta..." autocomplete="off">
                <br>
                <button class="btn-juego" style="background:var(--verde); color:white" onclick="enviarRespuesta()">ENVIAR</button>
                <button class="btn-juego" style="background:var(--oro); color:black" onclick="pasarPalabra()">PASAPALABRA</button>
            </div>
        </div>

        <div id="jugador-rival" class="jugador-rival oculto">
            <h3 id="rival-nick" style="color:white; margin-top: -30px; position:absolute;">RIVAL</h3>
            <div id="rosco-rival" class="rosco-container"></div>
        </div>
    </div>

<script>
    /* --- DATOS Y VARIABLES --- */
    const bancoPreguntas = [
        {l:"A", p:"Relativo a las abejas", r:"apícola"}, {l:"B", p:"Mide la dirección del viento", r:"veleta"},
        {l:"C", p:"Vehículo grande de carga", r:"camión"}, {l:"D", p:"Animal marino inteligente", r:"delfín"},
        {l:"E", p:"Cría de elefantes", r:"elefantería"}, {l:"F", p:"Luz que guía a los barcos", r:"faro"},
        {l:"G", p:"Ave de corral", r:"gallina"}, {l:"H", p:"Agua sólida", r:"hielo"},
        {l:"I", p:"Tierra rodeada de agua", r:"isla"}, {l:"J", p:"Animal de cuello largo", r:"jirafa"},
        {l:"L", p:"Líquido blanco de vaca", r:"leche"}, {l:"M", p:"Fruta del manzano", r:"manzana"},
        {l:"N", p:"Fruta cítrica", r:"naranja"}, {l:"Ñ", p:"Niño pequeño", r:"niño"},
        {l:"O", p:"Animal que da lana", r:"oveja"}, {l:"P", p:"Instrumento de teclas", r:"piano"},
        {l:"Q", p:"Derivado de la leche", r:"queso"}, {l:"R", p:"Pequeño roedor", r:"ratón"},
        {l:"S", p:"Astro rey", r:"sol"}, {l:"T", p:"Hablar a distancia", r:"teléfono"},
        {l:"U", p:"Fruta de la vid", r:"uva"}, {l:"V", p:"Vive al lado", r:"vecino"},
        {l:"X", p:"Instrumento musical", r:"xilófono"}, {l:"Y", p:"Barco de lujo", r:"yate"},
        {l:"Z", p:"Calzado", r:"zapato"}
    ];

    let nombre = "";
    let modo = ""; // 'solo' o 'online'
    let peer = null;
    let conn = null;
    let turnoActual = 1; // 1 = Yo (o Host), 2 = Rival
    let miRol = 1; // 1 si soy Host/Solo, 2 si soy Guest
    
    // Estado del juego
    let estado = {
        j1: { pos: 0, aciertos: [], nombre: "" },
        j2: { pos: 0, aciertos: [], nombre: "" }
    };
    // Inicializar arrays de respuesta (0:sin responder, 1:bien, 2:mal)
    estado.j1.aciertos = new Array(25).fill(0);
    estado.j2.aciertos = new Array(25).fill(0);

    /* --- NAVEGACIÓN DE PANTALLAS --- */
    function ocultarTodo() {
        document.querySelectorAll('.pantalla').forEach(p => p.classList.add('oculto'));
        document.getElementById('tablero-juego').style.display = 'none';
    }

    function irAModos() {
        nombre = document.getElementById('input-nombre').value.trim();
        if(!nombre) return alert("¡Ponte un nombre!");
        estado.j1.nombre = nombre;
        document.getElementById('saludo-titulo').innerText = "HOLA, " + nombre.toUpperCase();
        ocultarTodo();
        document.getElementById('pantalla-modos').classList.remove('oculto');
    }

    function volverAModos() {
        ocultarTodo();
        document.getElementById('pantalla-modos').classList.remove('oculto');
    }

    function irAOnline() {
        ocultarTodo();
        document.getElementById('pantalla-online-opciones').classList.remove('oculto');
    }

    function volverAOnline() {
        ocultarTodo();
        document.getElementById('pantalla-online-opciones').classList.remove('oculto');
    }

    /* --- MODO SOLO (LOCAL) --- */
    function modoSolo() {
        modo = 'solo';
        miRol = 1; 
        turnoActual = 1;
        document.getElementById('jugador-rival').classList.add('oculto'); // Ocultar rival
        iniciarJuegoUI();
    }

    /* --- MODO ONLINE (PEERJS) --- */
    function pantallaGenerar() {
        modo = 'online';
        miRol = 1; // Soy Host (Jugador 1)
        estado.j1.nombre = nombre;
        ocultarTodo();
        document.getElementById('pantalla-host').classList.remove('oculto');
        
        // Generar ID de 6 cifras
        const idSala = Math.floor(100000 + Math.random() * 900000);
        document.getElementById('codigo-mostrado').innerText = idSala;

        // Crear Peer
        peer = new Peer(idSala.toString());
        
        peer.on('open', (id) => {
            console.log('Mi ID es: ' + id);
        });

        peer.on('connection', (c) => {
            conn = c;
            document.getElementById('estado-host').innerText = "¡Alguien se está uniendo!";
            setupConexion();
        });
    }

    function pantallaUnirse() {
        modo = 'online';
        miRol = 2; // Soy Guest (Jugador 2)
        estado.j2.nombre = nombre;
        ocultarTodo();
        document.getElementById('pantalla-guest').classList.remove('oculto');
    }

    function conectarHost() {
        const codigo = document.getElementById('input-codigo').value;
        if(codigo.length !== 6) return alert("El código debe tener 6 cifras");
        
        document.getElementById('estado-guest').innerText = "Buscando sala...";
        peer = new Peer(); // ID automático para mí
        
        peer.on('open', () => {
            conn = peer.connect(codigo);
            
            conn.on('open', () => {
                document.getElementById('estado-guest').innerText = "¡Conectado! Esperando inicio...";
                setupConexion();
                // Enviar mi nombre al Host
                conn.send({ tipo: 'SALUDO', nombre: nombre });
            });
            
            // Si el código no existe o falla
            peer.on('error', (err) => {
                alert("Error: No se encuentra la sala o fallo de red.");
                document.getElementById('estado-guest').innerText = "";
            });
        });
    }

    function setupConexion() {
        conn.on('data', (data) => {
            // Lógica de recepción de datos
            if(data.tipo === 'SALUDO') {
                // Host recibe nombre del Guest
                if(miRol === 1) {
                    estado.j2.nombre = data.nombre;
                    // Host inicia el juego para ambos
                    enviarEstado('START');
                    iniciarJuegoUI();
                }
            }
            if(data.tipo === 'START') {
                estado = data.estado;
                iniciarJuegoUI();
            }
            if(data.tipo === 'UPDATE') {
                estado = data.estado;
                turnoActual = data.turno;
                actualizarTablero();
            }
        });
    }

    function enviarEstado(tipo) {
        if(conn) {
            conn.send({
                tipo: tipo, // 'START' o 'UPDATE'
                estado: estado,
                turno: turnoActual
            });
        }
    }

    /* --- LÓGICA DEL JUEGO --- */
    function iniciarJuegoUI() {
        ocultarTodo();
        document.getElementById('tablero-juego').style.display = 'block';
        
        // Configurar Nombres
        document.getElementById('mi-nick').innerText = (miRol === 1) ? estado.j1.nombre : estado.j2.nombre;
        document.getElementById('rival-nick').innerText = (miRol === 1) ? estado.j2.nombre : estado.j1.nombre;

        if(modo === 'online') {
            document.getElementById('jugador-rival').classList.remove('oculto');
        }

        // Crear roscos visuales
        crearRoscoHTML('rosco-yo', 260); // Grande
        crearRoscoHTML('rosco-rival', 80); // Pequeño

        actualizarTablero();
    }

    function crearRoscoHTML(idContainer, radio) {
        const container = document.getElementById(idContainer);
        container.innerHTML = "";
        const letras = "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ";
        
        for(let i=0; i<letras.length; i++) {
            let div = document.createElement('div');
            div.innerText = letras[i];
            div.classList.add('letra');
            
            // Corrección de ángulo: -90 grados para que A esté arriba
            let angulo = (i * 360 / 25) - 90;
            let radianes = angulo * (Math.PI / 180);
            
            // Posicionar desde el centro
            let x = Math.cos(radianes) * radio;
            let y = Math.sin(radianes) * radio;
            
            // Ajustar al centro del div (offset)
            div.style.left = `calc(50% + ${x}px - 19px)`; 
            div.style.top = `calc(50% + ${y}px - 19px)`;
            
            // IDs únicos para pintar luego: rosco-yo-0, rosco-rival-24
            div.id = `${idContainer}-${i}`; 
            
            container.appendChild(div);
        }
    }

    function actualizarTablero() {
        // Determinar qué datos son MÍOS y cuáles del RIVAL según mi rol
        let misDatos = (miRol === 1) ? estado.j1 : estado.j2;
        let rivalDatos = (miRol === 1) ? estado.j2 : estado.j1;

        // 1. Actualizar MI Rosco (Grande)
        pintarRosco('rosco-yo', misDatos);
        
        // 2. Actualizar Rosco Rival (Pequeño)
        pintarRosco('rosco-rival', rivalDatos);

        // 3. Pregunta y Turno
        // Si es mi turno
        if(turnoActual === miRol) {
            let letraActual = bancoPreguntas[misDatos.pos];
            document.getElementById('pregunta-texto').innerText = 
                `CON LA ${letraActual.l}: ${letraActual.p}`;
            document.getElementById('respuesta-input').disabled = false;
            document.getElementById('respuesta-input').focus();
            document.getElementById('jugador-yo').style.opacity = "1";
            document.getElementById('jugador-yo').style.borderColor = "var(--oro)";
            
            // Efecto visual: Rival oscuro
            if(modo === 'online') {
                document.getElementById('jugador-rival').style.opacity = "0.5";
            }
        } else {
            // Turno del rival
            document.getElementById('pregunta-texto').innerText = "ESPERANDO AL RIVAL...";
            document.getElementById('respuesta-input').disabled = true;
            document.getElementById('jugador-yo').style.opacity = "0.7";
            document.getElementById('jugador-yo').style.borderColor = "#555";
            
            if(modo === 'online') {
                document.getElementById('jugador-rival').style.opacity = "1";
                document.getElementById('jugador-rival').style.borderColor = "var(--oro)";
            }
        }
    }

    function pintarRosco(prefijoID, datosJugador) {
        for(let i=0; i<25; i++) {
            let el = document.getElementById(`${prefijoID}-${i}`);
            el.className = 'letra'; // Reset
            
            // Colores acertado/fallado
            if(datosJugador.aciertos[i] === 1) el.classList.add('bien');
            else if(datosJugador.aciertos[i] === 2) el.classList.add('mal');
            
            // Letra actual (solo si no ha terminado)
            if(i === datosJugador.pos) el.classList.add('actual');
        }
    }

    function enviarRespuesta() {
        if(turnoActual !== miRol) return;
        
        let misDatos = (miRol === 1) ? estado.j1 : estado.j2;
        let input = document.getElementById('respuesta-input');
        let respuesta = input.value.toLowerCase().trim();
        let correcta = bancoPreguntas[misDatos.pos].r;

        if(respuesta === correcta) {
            misDatos.aciertos[misDatos.pos] = 1; // Verde
            // Si acierta, SIGUE jugando. No cambiamos turno.
        } else {
            misDatos.aciertos[misDatos.pos] = 2; // Rojo
            cambiarTurno();
        }

        misDatos.pos = (misDatos.pos + 1) % 25; // Siguiente letra
        input.value = "";
        
        if(modo === 'online') enviarEstado('UPDATE');
        actualizarTablero();
    }

    function pasarPalabra() {
        if(turnoActual !== miRol) return;
        
        let misDatos = (miRol === 1) ? estado.j1 : estado.j2;
        // Solo cambia turno, no marca error
        misDatos.pos = (misDatos.pos + 1) % 25;
        cambiarTurno();
        
        document.getElementById('respuesta-input').value = "";
        
        if(modo === 'online') enviarEstado('UPDATE');
        actualizarTablero();
    }

    function cambiarTurno() {
        if(modo === 'solo') return; // En solo nunca cambia el turno
        turnoActual = (turnoActual === 1) ? 2 : 1;
    }

    // Enter para enviar
    document.getElementById('respuesta-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') enviarRespuesta();
    });

</script>
</body>
</html>
