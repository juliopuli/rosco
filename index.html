<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE ACCESO BIOMÉTRICO - ALPHA v2.0</title>
    
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    
    <style>
        /* CSS: DISEÑO TIPO TERMINAL DE SEGURIDAD */
        :root {
            --primary: #00ff41; /* Verde Matrix */
            --danger: #ff3e3e;
            --bg: #0a0a0a;
            --panel: #1a1a1a;
        }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        header {
            width: 100%;
            padding: 20px;
            background: #000;
            border-bottom: 2px solid var(--primary);
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            margin-top: 20px;
        }

        /* ÁREA DE VIDEO */
        .video-section {
            position: relative;
            background: var(--panel);
            padding: 15px;
            border: 1px solid var(--primary);
            border-radius: 5px;
            text-align: center;
        }

        #video-container {
            position: relative;
            display: inline-block;
            border: 2px solid #333;
        }

        video {
            display: block;
            border-radius: 4px;
            background: #000;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* PANEL LATERAL DE DATOS */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .data-panel {
            background: var(--panel);
            border: 1px solid var(--primary);
            padding: 15px;
            font-size: 0.8rem;
        }

        .status-box {
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            padding: 10px;
            border: 2px solid var(--primary);
            text-align: center;
            margin-bottom: 10px;
        }

        .access-denied { border-color: var(--danger); color: var(--danger); }
        .access-granted { border-color: var(--primary); color: var(--primary); }

        /* BOTONES */
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        button:hover {
            background: var(--primary);
            color: #000;
        }

        /* REGISTRO DE EVENTOS (LOGS) */
        #log-container {
            height: 300px;
            overflow-y: auto;
            background: #000;
            padding: 10px;
            border: 1px solid #333;
            font-size: 0.7rem;
            color: #888;
        }

        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; }
        .log-time { color: var(--primary); }

        /* ESCÁNER ANIMADO */
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 65, 0.5);
            top: 0;
            box-shadow: 0 0 15px var(--primary);
            animation: scan 3s infinite linear;
            z-index: 10;
            display: none;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
    </style>
</head>
<body>

<header>
    <h1>SYSTEM_OVERRIDE_BIOMETRIC_INTERFACE [SECURED]</h1>
</header>

<div class="main-container">
    <div class="video-section">
        <div id="video-container">
            <div id="scanner-line" class="scanner-line"></div>
            <video id="video" width="720" height="540" autoplay muted></video>
        </div>
        <div class="controls">
            <button id="btn-register">REGISTRAR CARA MAESTRA</button>
            <button id="btn-clear">RESETEAR SISTEMA</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="data-panel">
            <div id="status-display" class="status-box">SISTEMA OFFLINE</div>
            <p>CONEXIÓN: <span id="conn-status">ESTABLECIENDO...</span></p>
            <p>ID DISPOSITIVO: <span id="device-id">NODE_MALAGA_01</span></p>
            <p>SIMILITUD REQUERIDA: 0.60 (60%)</p>
        </div>

        <div class="data-panel">
            <h3>LOG DE ACTIVIDAD</h3>
            <div id="log-container">
                <div class="log-entry">> Inicializando módulos de IA...</div>
            </div>
        </div>
    </div>
</div>

<script>
    /* LÓGICA DEL SISTEMA: FACE-API.JS
       Aquí gestionamos el reconocimiento facial real
    */
    const video = document.getElementById('video');
    const statusDisplay = document.getElementById('status-display');
    const logContainer = document.getElementById('log-container');
    const scannerLine = document.getElementById('scanner-line');
    
    let faceMatcher = null;
    let labeledFaceDescriptors = [];

    // Función para añadir mensajes al Log
    function addLog(message) {
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="log-time">[${time}]</span> > ${message}`;
        logContainer.prepend(entry);
    }

    // 1. CARGA DE MODELOS
    async function initSystem() {
        addLog("Cargando redes neuronales...");
        const MODEL_URL = 'https://raw.githubusercontent.com/vladmandic/face-api/master/model/';
        
        try {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            
            addLog("Modelos cargados correctamente.");
            startVideo();
        } catch (err) {
            addLog("ERROR CRÍTICO: No se pudieron cargar los modelos.");
            console.error(err);
        }
    }

    // 2. INICIAR CÁMARA
    function startVideo() {
        navigator.mediaDevices.getUserMedia({ video: {} })
            .then(stream => {
                video.srcObject = stream;
                document.getElementById('conn-status').innerText = "ONLINE";
                document.getElementById('conn-status').style.color = "var(--primary)";
                statusDisplay.innerText = "ESPERANDO SUJETO";
                scannerLine.style.display = "block";
                addLog("Cámara activada. Iniciando escaneo de entorno.");
                startRecognition();
            })
            .catch(err => {
                addLog("ERROR: Fallo al acceder a la cámara web.");
            });
    }

    // 3. REGISTRAR CARA (La foto del escáner que decías)
    document.getElementById('btn-register').addEventListener('click', async () => {
        addLog("Capturando rostro maestro... Manténgase quieto.");
        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (detections) {
            labeledFaceDescriptors = [new faceapi.LabeledFaceDescriptors('USUARIO_AUTORIZADO', [detections.descriptor])];
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
            addLog("Rostro maestro guardado encriptado en memoria.");
            alert("¡Cara registrada con éxito!");
        } else {
            addLog("ERROR: No se detecta rostro para registrar.");
            alert("No se ve ninguna cara. Inténtalo de nuevo.");
        }
    });

    // 4. RECONOCIMIENTO EN TIEMPO REAL
    async function startRecognition() {
        const canvas = faceapi.createCanvasFromMedia(video);
        document.getElementById('video-container').append(canvas);
        const displaySize = { width: video.width, height: video.height };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();

            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar cuadros en las caras
            faceapi.draw.drawDetections(canvas, resizedDetections);

            if (faceMatcher && detections.length > 0) {
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                
                results.forEach(result => {
                    if (result.label === 'USUARIO_AUTORIZADO') {
                        statusDisplay.innerText = "ACCESO PERMITIDO";
                        statusDisplay.className = "status-box access-granted";
                        addLog("ALERTA: Usuario autorizado detectado.");
                    } else {
                        statusDisplay.innerText = "ACCESO DENEGADO";
                        statusDisplay.className = "status-box access-denied";
                        addLog("WARNING: Intento de acceso no autorizado.");
                    }
                });
            } else if (!faceMatcher && detections.length > 0) {
                statusDisplay.innerText = "SUJETO NO REGISTRADO";
                statusDisplay.className = "status-box";
            }
        }, 500);
    }

    // Reiniciar
    document.getElementById('btn-clear').addEventListener('click', () => {
        location.reload();
    });

    // Iniciar todo al cargar la página
    initSystem();
</script>

</body>
</html>
