<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasapalabra Pro v4.5.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --fondo: #050a1f; --panel: #111b3d; --oro: #ffcc00; --verde: #2ecc71; --rojo: #dc3545; --azul: #00c6ff; }
        body { background: var(--fondo); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        .oculto { display: none !important; }

        .pantalla { text-align: center; background: var(--panel); padding: 30px; border-radius: 20px; border: 1px solid #2a3a6d; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; }
        
        .btn { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; color: white; transition: 0.3s; }
        .btn-green { background: var(--verde); }
        .btn-blue { background: var(--azul); color: #000; }
        .btn-red { background: var(--rojo); }
        .btn-face { background: linear-gradient(90deg, #00c6ff, #0072ff); border: 1px solid #fff; box-shadow: 0 0 15px var(--azul); }
        .btn-staff { background: transparent; color: #666; font-size: 0.7rem; margin-top: 15px; border: 1px solid #333; }

        input { width: 90%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; text-align: center; font-size: 1rem; background: #eee; color: #000; font-weight: bold; }

        /* JUEGO ROSCO */
        #juego-cont { display: none; width: 100vw; height: 100vh; position: relative; }
        .rosco-main { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 420px; height: 420px; }
        .letra { position: absolute; width: 35px; height: 35px; background: #0044ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; transition: 0.3s; font-size: 0.8rem; }
        .letra.activa { background: var(--oro) !important; color: black; transform: scale(1.3); box-shadow: 0 0 15px var(--oro); z-index: 10; }

        /* C√ÅMARA Y ESC√ÅNER */
        #camara-container { width: 220px; height: 220px; margin: 10px auto; border-radius: 50%; border: 4px solid var(--verde); overflow: hidden; position: relative; background: #000; display: none; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--oro); box-shadow: 0 0 20px var(--oro); animation: escanear 1.5s infinite ease-in-out; }
        @keyframes escanear { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* PANEL FLOTANTE ADMIN */
        #hud-admin { display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); border: 1px solid var(--oro); padding: 15px; border-radius: 10px; z-index: 2000; text-align: center; min-width: 200px; }
    </style>
</head>
<body>

    <div id="hud-admin">
        <b style="color:var(--oro)">PANEL STAFF</b><br>
        <span id="hud-user">---</span><br>
        <hr style="border-color:#444">
        
        <button id="btn-lock-game" class="btn oculto" style="font-size:0.7rem; padding:8px;">BLOQUEAR JUEGO</button>
        <button id="btn-reg-face" class="btn btn-blue" style="font-size:0.7rem; padding:8px;" onclick="registrarRostro()">üì∏ REGISTRAR CARA</button>
        <button class="btn" style="background:#444; font-size:0.7rem; padding:8px;" onclick="location.reload()">SALIR</button>
    </div>

    <div id="p-inicio" class="pantalla">
        <h1 style="color:var(--oro)">PASAPALABRA</h1>
        <p>Introduce tu nombre</p>
        <input type="text" id="nombre-publico" placeholder="Jugador...">
        <button class="btn btn-green" onclick="entrarPublico()">ENTRAR</button>
    </div>

    <div id="p-bloqueo" class="pantalla oculto">
        <h1 style="color:var(--rojo); font-size:3rem;">‚õî</h1>
        <h2 style="color:var(--rojo)">ACCESO CERRADO</h2>
        <p>Solo personal autorizado.</p>
        <button class="btn btn-staff" onclick="pedirCodigoStaff()">ACCESO STAFF</button>
    </div>

    <div id="p-menu" class="pantalla oculto">
        <h2 id="msg-hola">HOLA</h2>
        <button class="btn btn-blue" onclick="mostrarOnline()">MODO ONLINE</button>
        <button class="btn btn-green" onclick="iniciarLocal()">MODO LOCAL</button>
        <button class="btn btn-staff" onclick="pedirCodigoStaff()">ACCESO STAFF</button>
    </div>

    <div id="p-login-staff" class="pantalla oculto">
        <h2 style="color:var(--oro)">IDENTIFICACI√ìN STAFF</h2>
        
        <div id="form-login-manual">
            <input type="text" id="st-user" placeholder="Usuario">
            <input type="password" id="st-pass" placeholder="Contrase√±a">
            <button class="btn btn-green" onclick="loginManual()">ENTRAR CON CLAVE</button>
        </div>

        <hr style="border-color:#333; margin: 15px 0;">

        <p style="font-size:0.8rem; color:#aaa;">Zona Biom√©trica</p>
        <button class="btn btn-face" onclick="mostrarInputFace()">üëÅÔ∏è RECONOCIMIENTO FACIAL</button>
        <button class="btn btn-staff" onclick="location.reload()">VOLVER</button>
    </div>

    <div id="p-scanner" class="pantalla oculto">
        <h3 style="color:var(--azul)">ESCANER DE RANGO</h3>
        <p id="scan-instruction">Introduce tu categor√≠a:</p>
        
        <input type="text" id="face-rank-input" placeholder="Ej: SUPERADMIN">
        
        <div id="camara-container">
            <video id="video-feed" autoplay playsinline></video>
            <div class="scan-line"></div>
        </div>
        
        <button id="btn-iniciar-scan" class="btn btn-blue" onclick="iniciarEscaneoRango()">INICIAR ESCANEO</button>
        <p id="scan-status" style="color:var(--oro); font-weight:bold;"></p>
        <button class="btn btn-staff" onclick="location.reload()">CANCELAR</button>
    </div>

    <div id="p-online-lobby" class="pantalla oculto">
        <h2>ONLINE</h2>
        <button class="btn btn-blue" onclick="crearSala()">CREAR SALA</button>
        <h3 id="sala-id-display" style="color:var(--oro)"></h3>
        <hr>
        <input type="text" id="input-sala" placeholder="C√≥digo de sala">
        <button class="btn btn-green" onclick="unirseSala()">UNIRSE</button>
        <button class="btn btn-staff" onclick="irMenu()">VOLVER</button>
    </div>

    <div id="juego-cont">
        <div class="rosco-main" id="rosco-container"></div>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; width:300px;">
            <div id="pregunta-txt" style="font-weight:bold; font-size:1.2rem; min-height:80px; text-shadow: 0 2px 4px black;">PREPARANDO ROSCO...</div>
            <input type="text" id="ans-in" placeholder="Respuesta...">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-green" style="padding:10px" onclick="enviarRespuesta()">ENVIAR</button>
                <button class="btn" style="background:var(--oro); color:black; padding:10px" onclick="pasarPalabra()">PASO</button>
            </div>
        </div>
    </div>

<script>
    // --- DATOS ---
    const CODIGO_MAESTRO = "Pablo23sek";
    
    // Mapeo RANGO -> USUARIO
    const rangosDB = {
        "SUPERADMIN": "pablo",
        "ADMIN": "juliopuli",
        "VISUALIZADOR": "alvarito"
    };

    const staffDB = {
        "pablo": { pass: "Pablo23sek", rango: "SUPERADMIN", super: true },
        "juliopuli": { pass: "juli26", rango: "ADMIN", super: false },
        "alvarito": { pass: "poki", rango: "VISUALIZADOR", super: false }
    };

    let sistemaBloqueado = localStorage.getItem('globalLock') === 'true';
    let usuarioActual = "";
    let peer = null, conn = null;

    // --- ENTRADA ---
    function entrarPublico() {
        const n = document.getElementById('nombre-publico').value;
        if(sistemaBloqueado) return cambiarPantalla('p-bloqueo');
        if(n) { usuarioActual = n; irMenu(); }
    }

    function irMenu() {
        cambiarPantalla('p-menu');
        document.getElementById('msg-hola').innerText = "HOLA, " + usuarioActual.toUpperCase();
    }

    function pedirCodigoStaff() {
        if(prompt("C√ìDIGO SECRETO:") === CODIGO_MAESTRO) cambiarPantalla('p-login-staff');
        else alert("C√≥digo incorrecto");
    }

    // --- LOGIN MANUAL ---
    function loginManual() {
        const u = document.getElementById('st-user').value.toLowerCase();
        const p = document.getElementById('st-pass').value;
        if (staffDB[u] && staffDB[u].pass === p) accesoStaffConcedido(u);
        else alert("Credenciales mal");
    }

    // --- FACE ID POR RANGO (CORREGIDO) ---
    function mostrarInputFace() { cambiarPantalla('p-scanner'); }

    async function iniciarEscaneoRango() {
        const rangoInput = document.getElementById('face-rank-input').value.toUpperCase().trim();
        const status = document.getElementById('scan-status');

        // 1. Buscamos qu√© usuario tiene este rango
        const usuarioAsociado = rangosDB[rangoInput];

        if (!usuarioAsociado) return alert("Esa categor√≠a no existe o est√° mal escrita.");

        // 2. Verificamos si ese usuario tiene la cara guardada
        const tieneCara = localStorage.getItem('faceID_' + usuarioAsociado);
        if (!tieneCara) {
            status.style.color = "red";
            status.innerText = "ERROR: El rango " + rangoInput + " no tiene rostro registrado. Entra con clave y reg√≠stralo.";
            return;
        }

        // 3. Encender c√°mara
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('camara-container').style.display = "block";
            document.getElementById('video-feed').srcObject = stream;
            document.getElementById('btn-iniciar-scan').style.display = "none";
            document.getElementById('face-rank-input').style.display = "none";
            
            status.style.color = "var(--oro)";
            status.innerText = "Verificando identidad de " + rangoInput + "...";
            
            setTimeout(() => {
                stream.getTracks().forEach(t => t.stop());
                accesoStaffConcedido(usuarioAsociado);
            }, 3000);

        } catch (e) { alert("Error c√°mara"); }
    }

    // --- ACCESO STAFF ---
    function accesoStaffConcedido(user) {
        usuarioActual = user.toUpperCase();
        document.getElementById('hud-admin').style.display = "block";
        document.getElementById('hud-user').innerText = usuarioActual + " (" + staffDB[user].rango + ")";
        
        if(staffDB[user].super) {
            const btn = document.getElementById('btn-lock-game');
            btn.classList.remove('oculto');
            btn.innerText = sistemaBloqueado ? "üîì DESBLOQUEAR" : "üîí BLOQUEAR";
            btn.className = sistemaBloqueado ? "btn btn-green" : "btn btn-red";
            btn.onclick = () => {
                sistemaBloqueado = !sistemaBloqueado;
                localStorage.setItem('globalLock', sistemaBloqueado);
                location.reload();
            };
        }
        irMenu();
    }

    // --- REGISTRAR CARA ---
    async function registrarRostro() {
        const user = usuarioActual.toLowerCase(); // ej: pablo
        if(confirm("¬øGuardar tu cara para el usuario " + user.toUpperCase() + "?")) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                // Simulaci√≥n visual r√°pida
                alert("Escaneando... mant√©n la cara quieta.");
                setTimeout(() => {
                    localStorage.setItem('faceID_' + user, 'true'); // GUARDADO
                    stream.getTracks().forEach(t => t.stop());
                    alert("‚úÖ CARA GUARDADA CORRECTAMENTE.\nAhora puedes entrar poniendo tu rango.");
                }, 2000);
            } catch(e) { alert("No se pudo acceder a la c√°mara"); }
        }
    }

    // --- GAME MODES (ARREGLADOS) ---
    function iniciarLocal() {
        document.querySelectorAll('.pantalla').forEach(p => p.classList.add('oculto'));
        document.getElementById('juego-cont').style.display = "block";
        dibujarRosco();
        document.getElementById('pregunta-txt').innerText = "MODO LOCAL: Empieza por la A...";
    }

    function mostrarOnline() {
        cambiarPantalla('p-online-lobby');
    }

    // --- L√ìGICA PEERJS (ONLINE) ---
    function crearSala() {
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer(id);
        peer.on('open', (id) => {
            document.getElementById('sala-id-display').innerText = "C√ìDIGO: " + id;
        });
        peer.on('connection', (c) => {
            conn = c;
            conn.on('open', () => iniciarLocal());
        });
    }

    function unirseSala() {
        const id = document.getElementById('input-sala').value;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id);
            conn.on('open', () => iniciarLocal());
        });
    }

    // --- DIBUJAR ROSCO ---
    function dibujarRosco() {
        const container = document.getElementById('rosco-container');
        container.innerHTML = "";
        const letras = "ABCDEFGHIJKLMN√ëOPQRSTUVWXY Z".split("");
        for(let i=0; i<26; i++) {
            const div = document.createElement('div');
            div.className = "letra";
            div.innerText = letras[i];
            const ang = (i * (360/26)) - 90;
            const rad = ang * (Math.PI / 180);
            const x = Math.cos(rad) * 190;
            const y = Math.sin(rad) * 190;
            div.style.left = `calc(50% + ${x}px - 17px)`;
            div.style.top = `calc(50% + ${y}px - 17px)`;
            if(i===0) div.classList.add('activa');
            container.appendChild(div);
        }
    }

    function cambiarPantalla(id) {
        document.querySelectorAll('.pantalla').forEach(p => p.classList.add('oculto'));
        document.getElementById(id).classList.remove('oculto');
    }
</script>
</body>
</html>
