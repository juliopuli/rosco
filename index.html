<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: #050510; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        /* Pantalla de Inicio */
        #menu-inicial, #menu-online { background: #16213e; padding: 40px; border-radius: 20px; text-align: center; margin-top: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Contenedores de Roscos */
        #juego { display: none; width: 100%; max-width: 1000px; justify-content: space-around; flex-wrap: wrap; }
        .rosco-box { text-align: center; position: relative; width: 420px; height: 450px; }
        .rosco-container { position: relative; width: 350px; height: 350px; margin: 0 auto; }
        
        /* Estilos Letras */
        .letra { position: absolute; width: 28px; height: 28px; background: #0044cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; transform: translate(-50%, -50%); font-size: 12px; transition: 0.3s; }
        .activa { border: 4px solid #f1c40f; scale: 1.2; box-shadow: 0 0 15px #f1c40f; }
        .acierto { background: #2ecc71 !important; }
        .fallo { background: #e74c3c !important; }

        /* Panel de control */
        #panel-control { background: #16213e; padding: 20px; border-radius: 15px; margin-top: 20px; width: 90%; max-width: 500px; text-align: center; }
        input { padding: 10px; border-radius: 5px; border: none; margin: 10px; width: 70%; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; background: #2ecc71; color: white; margin: 5px; }
        .btn-blue { background: #0044cc; }
        .turno-aviso { color: #f1c40f; font-weight: bold; margin: 10px; height: 24px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1>PASAPALABRA</h1>
        <button class="btn-blue" onclick="iniciarLocal()">MODO LOCAL</button>
        <button onclick="mostrarOnline()">MODO ONLINE</button>
    </div>

    <div id="menu-online" class="hidden">
        <h2>Modo Online</h2>
        <input type="text" id="sala-id" placeholder="Código de sala (ej: PATATA123)">
        <br>
        <button onclick="conectarOnline('host')">GENERAR CÓDIGO (Ser Jugador 1)</button>
        <button class="btn-blue" onclick="conectarOnline('guest')">UNIRSE A PARTIDA (Ser Jugador 2)</button>
        <br>
        <button style="background: #555" onclick="location.reload()">VOLVER</button>
    </div>

    <div id="juego">
        <div class="rosco-box">
            <h3 id="nombre-j1">Jugador 1</h3>
            <div id="rosco1" class="rosco-container"></div>
        </div>
        
        <div id="panel-control">
            <div id="turno-texto" class="turno-aviso">Esperando contrincante...</div>
            <h4 id="pregunta-texto">La pregunta aparecerá aquí</h4>
            <div id="interaccion">
                <input type="text" id="input-respuesta" placeholder="Escribe tu respuesta..." autocomplete="off">
                <br>
                <button onclick="enviarAccion('responder')">RESPONDER</button>
                <button style="background:#f1c40f; color:black" onclick="enviarAccion('pasapalabra')">PASAPALABRA</button>
            </div>
        </div>

        <div class="rosco-box">
            <h3 id="nombre-j2">Jugador 2</h3>
            <div id="rosco2" class="rosco-container"></div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN MQTT
        let client;
        let salaActual = "";
        let miRol = "local"; // host, guest, local
        let miTurno = true;
        let misAciertos = 0;
        let misFallos = 0;
        let preguntas = [];
        let indexPregunta = 0;

        // Estado de los roscos
        let estadoJ1 = []; 
        let estadoJ2 = [];

        async function cargarPreguntas() {
            const res = await fetch('preguntas.json?v=' + Date.now());
            preguntas = await res.json();
            estadoJ1 = preguntas.map(p => 'pendiente');
            estadoJ2 = preguntas.map(p => 'pendiente');
        }

        // --- LÓGICA DE NAVEGACIÓN ---
        function iniciarLocal() {
            miRol = "local";
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('juego').style.display = 'flex';
            document.getElementById('nombre-j2').classList.add('hidden');
            document.getElementById('rosco2').classList.add('hidden');
            document.getElementById('turno-texto').innerText = "MODO LOCAL";
            setupPartida();
        }

        function mostrarOnline() {
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('menu-online').classList.remove('hidden');
        }

        // --- LÓGICA MQTT ---
        function conectarOnline(rol) {
            salaActual = document.getElementById('sala-id').value.trim();
            if(!salaActual) return alert("Pon un código");
            
            miRol = rol;
            miTurno = (rol === 'host');

            // Conectar al broker gratuito de HiveMQ (vía WebSockets)
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "user_" + Math.random());
            
            client.onMessageArrived = recibirMensaje;
            client.connect({ onSuccess: () => {
                client.subscribe("pasapalabra/" + salaActual);
                document.getElementById('menu-online').classList.add('hidden');
                document.getElementById('juego').style.display = 'flex';
                setupPartida();
                
                // Avisar que estamos listos
                enviarMQTT({ tipo: 'SISTEMA', texto: 'Jugador conectado', rol: miRol });
            }});
        }

        function enviarMQTT(obj) {
            if(miRol === 'local') return;
            const message = new Paho.MQTT.Message(JSON.stringify(obj));
            message.destinationName = "pasapalabra/" + salaActual;
            client.send(message);
        }

        function recibirMensaje(msg) {
            const data = JSON.parse(msg.payloadString);
            
            // Si el otro responde, actualizamos su rosco
            if(data.tipo === 'ACCION') {
                if(data.rol !== miRol) {
                    const roscoEnemigo = (data.rol === 'host') ? estadoJ1 : estadoJ2;
                    roscoEnemigo[data.idx] = data.resultado;
                    dibujarRoscos();
                    
                    if(data.resultado !== 'acierto') {
                        miTurno = true;
                        actualizarUI();
                    }
                }
            }
        }

        // --- LÓGICA DEL JUEGO ---
        async function setupPartida() {
            await cargarPreguntas();
            dibujarRoscos();
            actualizarUI();
        }

        function dibujarRoscos() {
            renderRosco('rosco1', estadoJ1, (miRol === 'host' && miTurno));
            renderRosco('rosco2', estadoJ2, (miRol === 'guest' && miTurno));
        }

        function renderRosco(id, estados, resaltado) {
            const cont = document.getElementById(id);
            cont.innerHTML = "";
            estados.forEach((est, i) => {
                const ang = (i * (360 / 24)) - 90;
                const rad = ang * Math.PI / 180;
                const div = document.createElement('div');
                div.className = `letra ${est}`;
                if(resaltado && i === indexPregunta) div.classList.add('activa');
                div.style.left = (175 + 150 * Math.cos(rad)) + 'px';
                div.style.top = (175 + 150 * Math.sin(rad)) + 'px';
                div.innerText = preguntas[i].letra;
                cont.appendChild(div);
            });
        }

        function actualizarUI() {
            const p = preguntas[indexPregunta];
            document.getElementById('pregunta-texto').innerText = `${p.tipo} ${p.letra}: ${p.pregunta}`;
            document.getElementById('turno-texto').innerText = miTurno ? "TU TURNO" : "TURNO DEL OPONENTE";
            document.getElementById('interaccion').style.opacity = miTurno ? "1" : "0.3";
            document.getElementById('input-respuesta').disabled = !miTurno;
        }

        function enviarAccion(tipo) {
            if(!miTurno) return;

            const input = document.getElementById('input-respuesta');
            const user = input.value.toLowerCase().trim(); // Aquí iría tu lógica de Levenshtein
            const target = preguntas[indexPregunta].respuesta.toLowerCase();
            
            let resultado = "";

            if(tipo === 'pasapalabra') {
                resultado = 'pendiente';
                miTurno = false; // En online, pasapalabra cede turno
            } else {
                if(user === target) { // Simplificado para este ejemplo
                    resultado = 'acierto';
                    (miRol === 'host' || miRol === 'local' ? estadoJ1 : estadoJ2)[indexPregunta] = 'acierto';
                } else {
                    resultado = 'fallo';
                    (miRol === 'host' || miRol === 'local' ? estadoJ1 : estadoJ2)[indexPregunta] = 'fallo';
                    miTurno = false;
                }
            }

            // Sincronizar por MQTT
            enviarMQTT({
                tipo: 'ACCION',
                rol: miRol,
                idx: indexPregunta,
                resultado: resultado
            });

            // Mover índice a la siguiente pendiente
            avanzarPregunta();
            input.value = "";
            dibujarRoscos();
            actualizarUI();
        }

        function avanzarPregunta() {
            // Lógica para buscar la siguiente letra azul
            indexPregunta = (indexPregunta + 1) % 24;
            const miEstado = (miRol === 'host' || miRol === 'local') ? estadoJ1 : estadoJ2;
            let vueltas = 0;
            while(miEstado[indexPregunta] !== 'pendiente' && vueltas < 24) {
                indexPregunta = (indexPregunta + 1) % 24;
                vueltas++;
            }
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: #050510; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        /* Pantalla de Inicio */
        #menu-inicial, #menu-online { background: #16213e; padding: 40px; border-radius: 20px; text-align: center; margin-top: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Contenedores de Roscos */
        #juego { display: none; width: 100%; max-width: 1000px; justify-content: space-around; flex-wrap: wrap; }
        .rosco-box { text-align: center; position: relative; width: 420px; height: 450px; }
        .rosco-container { position: relative; width: 350px; height: 350px; margin: 0 auto; }
        
        /* Estilos Letras */
        .letra { position: absolute; width: 28px; height: 28px; background: #0044cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; transform: translate(-50%, -50%); font-size: 12px; transition: 0.3s; }
        .activa { border: 4px solid #f1c40f; scale: 1.2; box-shadow: 0 0 15px #f1c40f; }
        .acierto { background: #2ecc71 !important; }
        .fallo { background: #e74c3c !important; }

        /* Panel de control */
        #panel-control { background: #16213e; padding: 20px; border-radius: 15px; margin-top: 20px; width: 90%; max-width: 500px; text-align: center; }
        input { padding: 10px; border-radius: 5px; border: none; margin: 10px; width: 70%; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; background: #2ecc71; color: white; margin: 5px; }
        .btn-blue { background: #0044cc; }
        .turno-aviso { color: #f1c40f; font-weight: bold; margin: 10px; height: 24px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1>PASAPALABRA</h1>
        <button class="btn-blue" onclick="iniciarLocal()">MODO LOCAL</button>
        <button onclick="mostrarOnline()">MODO ONLINE</button>
    </div>

    <div id="menu-online" class="hidden">
        <h2>Modo Online</h2>
        <input type="text" id="sala-id" placeholder="Código de sala (ej: PATATA123)">
        <br>
        <button onclick="conectarOnline('host')">GENERAR CÓDIGO (Ser Jugador 1)</button>
        <button class="btn-blue" onclick="conectarOnline('guest')">UNIRSE A PARTIDA (Ser Jugador 2)</button>
        <br>
        <button style="background: #555" onclick="location.reload()">VOLVER</button>
    </div>

    <div id="juego">
        <div class="rosco-box">
            <h3 id="nombre-j1">Jugador 1</h3>
            <div id="rosco1" class="rosco-container"></div>
        </div>
        
        <div id="panel-control">
            <div id="turno-texto" class="turno-aviso">Esperando contrincante...</div>
            <h4 id="pregunta-texto">La pregunta aparecerá aquí</h4>
            <div id="interaccion">
                <input type="text" id="input-respuesta" placeholder="Escribe tu respuesta..." autocomplete="off">
                <br>
                <button onclick="enviarAccion('responder')">RESPONDER</button>
                <button style="background:#f1c40f; color:black" onclick="enviarAccion('pasapalabra')">PASAPALABRA</button>
            </div>
        </div>

        <div class="rosco-box">
            <h3 id="nombre-j2">Jugador 2</h3>
            <div id="rosco2" class="rosco-container"></div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN MQTT
        let client;
        let salaActual = "";
        let miRol = "local"; // host, guest, local
        let miTurno = true;
        let misAciertos = 0;
        let misFallos = 0;
        let preguntas = [];
        let indexPregunta = 0;

        // Estado de los roscos
        let estadoJ1 = []; 
        let estadoJ2 = [];

        async function cargarPreguntas() {
            const res = await fetch('preguntas.json?v=' + Date.now());
            preguntas = await res.json();
            estadoJ1 = preguntas.map(p => 'pendiente');
            estadoJ2 = preguntas.map(p => 'pendiente');
        }

        // --- LÓGICA DE NAVEGACIÓN ---
        function iniciarLocal() {
            miRol = "local";
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('juego').style.display = 'flex';
            document.getElementById('nombre-j2').classList.add('hidden');
            document.getElementById('rosco2').classList.add('hidden');
            document.getElementById('turno-texto').innerText = "MODO LOCAL";
            setupPartida();
        }

        function mostrarOnline() {
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('menu-online').classList.remove('hidden');
        }

        // --- LÓGICA MQTT ---
        function conectarOnline(rol) {
            salaActual = document.getElementById('sala-id').value.trim();
            if(!salaActual) return alert("Pon un código");
            
            miRol = rol;
            miTurno = (rol === 'host');

            // Conectar al broker gratuito de HiveMQ (vía WebSockets)
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "user_" + Math.random());
            
            client.onMessageArrived = recibirMensaje;
            client.connect({ onSuccess: () => {
                client.subscribe("pasapalabra/" + salaActual);
                document.getElementById('menu-online').classList.add('hidden');
                document.getElementById('juego').style.display = 'flex';
                setupPartida();
                
                // Avisar que estamos listos
                enviarMQTT({ tipo: 'SISTEMA', texto: 'Jugador conectado', rol: miRol });
            }});
        }

        function enviarMQTT(obj) {
            if(miRol === 'local') return;
            const message = new Paho.MQTT.Message(JSON.stringify(obj));
            message.destinationName = "pasapalabra/" + salaActual;
            client.send(message);
        }

        function recibirMensaje(msg) {
            const data = JSON.parse(msg.payloadString);
            
            // Si el otro responde, actualizamos su rosco
            if(data.tipo === 'ACCION') {
                if(data.rol !== miRol) {
                    const roscoEnemigo = (data.rol === 'host') ? estadoJ1 : estadoJ2;
                    roscoEnemigo[data.idx] = data.resultado;
                    dibujarRoscos();
                    
                    if(data.resultado !== 'acierto') {
                        miTurno = true;
                        actualizarUI();
                    }
                }
            }
        }

        // --- LÓGICA DEL JUEGO ---
        async function setupPartida() {
            await cargarPreguntas();
            dibujarRoscos();
            actualizarUI();
        }

        function dibujarRoscos() {
            renderRosco('rosco1', estadoJ1, (miRol === 'host' && miTurno));
            renderRosco('rosco2', estadoJ2, (miRol === 'guest' && miTurno));
        }

        function renderRosco(id, estados, resaltado) {
            const cont = document.getElementById(id);
            cont.innerHTML = "";
            estados.forEach((est, i) => {
                const ang = (i * (360 / 24)) - 90;
                const rad = ang * Math.PI / 180;
                const div = document.createElement('div');
                div.className = `letra ${est}`;
                if(resaltado && i === indexPregunta) div.classList.add('activa');
                div.style.left = (175 + 150 * Math.cos(rad)) + 'px';
                div.style.top = (175 + 150 * Math.sin(rad)) + 'px';
                div.innerText = preguntas[i].letra;
                cont.appendChild(div);
            });
        }

        function actualizarUI() {
            const p = preguntas[indexPregunta];
            document.getElementById('pregunta-texto').innerText = `${p.tipo} ${p.letra}: ${p.pregunta}`;
            document.getElementById('turno-texto').innerText = miTurno ? "TU TURNO" : "TURNO DEL OPONENTE";
            document.getElementById('interaccion').style.opacity = miTurno ? "1" : "0.3";
            document.getElementById('input-respuesta').disabled = !miTurno;
        }

        function enviarAccion(tipo) {
            if(!miTurno) return;

            const input = document.getElementById('input-respuesta');
            const user = input.value.toLowerCase().trim(); // Aquí iría tu lógica de Levenshtein
            const target = preguntas[indexPregunta].respuesta.toLowerCase();
            
            let resultado = "";

            if(tipo === 'pasapalabra') {
                resultado = 'pendiente';
                miTurno = false; // En online, pasapalabra cede turno
            } else {
                if(user === target) { // Simplificado para este ejemplo
                    resultado = 'acierto';
                    (miRol === 'host' || miRol === 'local' ? estadoJ1 : estadoJ2)[indexPregunta] = 'acierto';
                } else {
                    resultado = 'fallo';
                    (miRol === 'host' || miRol === 'local' ? estadoJ1 : estadoJ2)[indexPregunta] = 'fallo';
                    miTurno = false;
                }
            }

            // Sincronizar por MQTT
            enviarMQTT({
                tipo: 'ACCION',
                rol: miRol,
                idx: indexPregunta,
                resultado: resultado
            });

            // Mover índice a la siguiente pendiente
            avanzarPregunta();
            input.value = "";
            dibujarRoscos();
            actualizarUI();
        }

        function avanzarPregunta() {
            // Lógica para buscar la siguiente letra azul
            indexPregunta = (indexPregunta + 1) % 24;
            const miEstado = (miRol === 'host' || miRol === 'local') ? estadoJ1 : estadoJ2;
            let vueltas = 0;
            while(miEstado[indexPregunta] !== 'pendiente' && vueltas < 24) {
                indexPregunta = (indexPregunta + 1) % 24;
                vueltas++;
            }
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { background: #050510; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        /* Pantalla de Inicio */
        #menu-inicial, #menu-online { background: #16213e; padding: 40px; border-radius: 20px; text-align: center; margin-top: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Contenedores de Roscos */
        #juego { display: none; width: 100%; max-width: 1000px; justify-content: space-around; flex-wrap: wrap; }
        .rosco-box { text-align: center; position: relative; width: 420px; height: 450px; }
        .rosco-container { position: relative; width: 350px; height: 350px; margin: 0 auto; }
        
        /* Estilos Letras */
        .letra { position: absolute; width: 28px; height: 28px; background: #0044cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; transform: translate(-50%, -50%); font-size: 12px; transition: 0.3s; }
        .activa { border: 4px solid #f1c40f; scale: 1.2; box-shadow: 0 0 15px #f1c40f; }
        .acierto { background: #2ecc71 !important; }
        .fallo { background: #e74c3c !important; }

        /* Panel de control */
        #panel-control { background: #16213e; padding: 20px; border-radius: 15px; margin-top: 20px; width: 90%; max-width: 500px; text-align: center; }
        input { padding: 10px; border-radius: 5px; border: none; margin: 10px; width: 70%; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; background: #2ecc71; color: white; margin: 5px; }
        .btn-blue { background: #0044cc; }
        .turno-aviso { color: #f1c40f; font-weight: bold; margin: 10px; height: 24px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="menu-inicial">
        <h1>PASAPALABRA</h1>
        <button class="btn-blue" onclick="iniciarLocal()">MODO LOCAL</button>
        <button onclick="mostrarOnline()">MODO ONLINE</button>
    </div>

    <div id="menu-online" class="hidden">
        <h2>Modo Online</h2>
        <input type="text" id="sala-id" placeholder="Código de sala (ej: PATATA123)">
        <br>
        <button onclick="conectarOnline('host')">GENERAR CÓDIGO (Ser Jugador 1)</button>
        <button class="btn-blue" onclick="conectarOnline('guest')">UNIRSE A PARTIDA (Ser Jugador 2)</button>
        <br>
        <button style="background: #555" onclick="location.reload()">VOLVER</button>
    </div>

    <div id="juego">
        <div class="rosco-box">
            <h3 id="nombre-j1">Jugador 1</h3>
            <div id="rosco1" class="rosco-container"></div>
        </div>
        
        <div id="panel-control">
            <div id="turno-texto" class="turno-aviso">Esperando contrincante...</div>
            <h4 id="pregunta-texto">La pregunta aparecerá aquí</h4>
            <div id="interaccion">
                <input type="text" id="input-respuesta" placeholder="Escribe tu respuesta..." autocomplete="off">
                <br>
                <button onclick="enviarAccion('responder')">RESPONDER</button>
                <button style="background:#f1c40f; color:black" onclick="enviarAccion('pasapalabra')">PASAPALABRA</button>
            </div>
        </div>

        <div class="rosco-box">
            <h3 id="nombre-j2">Jugador 2</h3>
            <div id="rosco2" class="rosco-container"></div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN MQTT
        let client;
        let salaActual = "";
        let miRol = "local"; // host, guest, local
        let miTurno = true;
        let misAciertos = 0;
        let misFallos = 0;
        let preguntas = [];
        let indexPregunta = 0;

        // Estado de los roscos
        let estadoJ1 = []; 
        let estadoJ2 = [];

        async function cargarPreguntas() {
            const res = await fetch('preguntas.json?v=' + Date.now());
            preguntas = await res.json();
            estadoJ1 = preguntas.map(p => 'pendiente');
            estadoJ2 = preguntas.map(p => 'pendiente');
        }

        // --- LÓGICA DE NAVEGACIÓN ---
        function iniciarLocal() {
            miRol = "local";
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('juego').style.display = 'flex';
            document.getElementById('nombre-j2').classList.add('hidden');
            document.getElementById('rosco2').classList.add('hidden');
            document.getElementById('turno-texto').innerText = "MODO LOCAL";
            setupPartida();
        }

        function mostrarOnline() {
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('menu-online').classList.remove('hidden');
        }

        // --- LÓGICA MQTT ---
        function conectarOnline(rol) {
            salaActual = document.getElementById('sala-id').value.trim();
            if(!salaActual) return alert("Pon un código");
            
            miRol = rol;
            miTurno = (rol === 'host');

            // Conectar al broker gratuito de HiveMQ (vía WebSockets)
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "user_" + Math.random());
            
            client.onMessageArrived = recibirMensaje;
            client.connect({ onSuccess: () => {
                client.subscribe("pasapalabra/" + salaActual);
                document.getElementById('menu-online').classList.add('hidden');
                document.getElementById('juego').style.display = 'flex';
                setupPartida();
                
                // Avisar que estamos listos
                enviarMQTT({ tipo: 'SISTEMA', texto: 'Jugador conectado', rol: miRol });
            }});
        }

        function enviarMQTT(obj) {
            if(miRol === 'local') return;
            const message = new Paho.MQTT.Message(JSON.stringify(obj));
            message.destinationName = "pasapalabra/" + salaActual;
            client.send(message);
        }

        function recibirMensaje(msg) {
            const data = JSON.parse(msg.payloadString);
            
            // Si el otro responde, actualizamos su rosco
            if(data.tipo === 'ACCION') {
                if(data.rol !== miRol) {
                    const roscoEnemigo = (data.rol === 'host') ? estadoJ1 : estadoJ2;
                    roscoEnemigo[data.idx] = data.resultado;
                    dibujarRoscos();
                    
                    if(data.resultado !== 'acierto') {
                        miTurno = true;
                        actualizarUI();
                    }
                }
            }
        }

        // --- LÓGICA DEL JUEGO ---
        async function setupPartida() {
            await cargarPreguntas();
            dibujarRoscos();
            actualizarUI();
        }

        function dibujarRoscos() {
            renderRosco('rosco1', estadoJ1, (miRol === 'host' && miTurno));
            renderRosco('rosco2', estadoJ2, (miRol === 'guest' && miTurno));
        }

        function renderRosco(id, estados, resaltado) {
            const cont = document.getElementById(id);
            cont.innerHTML = "";
            estados.forEach((est, i) => {
                const ang = (i * (360 / 24)) - 90;
                const rad = ang * Math.PI / 180;
                const div = document.createElement('div');
                div.className = `letra ${est}`;
                if(resaltado && i === indexPregunta) div.classList.add('activa');
                div.style.left = (175 + 150 * Math.cos(rad)) + 'px';
                div.style.top = (175 + 150 * Math.sin(rad)) + 'px';
                div.innerText = preguntas[i].letra;
                cont.appendChild(div);
            });
        }

        function actualizarUI() {
            const p = preguntas[indexPregunta];
            document.getElementById('pregunta-texto').innerText = `${p.tipo} ${p.letra}: ${p.pregunta}`;
            document.getElementById('turno-texto').innerText = miTurno ? "TU TURNO" : "TURNO DEL OPONENTE";
            document.getElementById('interaccion').style.opacity = miTurno ? "1" : "0.3";
            document.getElementById('input-respuesta').disabled = !miTurno;
        }

        function enviarAccion(tipo) {
            if(!miTurno) return;

            const input = document.getElementById('input-respuesta');
            const user = input.value.toLowerCase().trim(); // Aquí iría tu lógica de Levenshtein
            const target = preguntas[indexPregunta].respuesta.toLowerCase();
            
            let resultado = "";

            if(tipo === 'pasapalabra') {
                resultado = 'pendiente';
                miTurno = false; // En online, pasapalabra cede turno
            } else {
                if(user === target) { // Simplificado para este ejemplo
                    resultado = 'acierto';
                    (miRol === 'host' || miRol === 'local' ? estadoJ1 : estadoJ2)[indexPregunta] = 'acierto';
                } else {
                    resultado = 'fallo';
                    (miRol === 'host' || miRol === 'local' ? estadoJ1 : estadoJ2)[indexPregunta] = 'fallo';
                    miTurno = false;
                }
            }

            // Sincronizar por MQTT
            enviarMQTT({
                tipo: 'ACCION',
                rol: miRol,
                idx: indexPregunta,
                resultado: resultado
            });

            // Mover índice a la siguiente pendiente
            avanzarPregunta();
            input.value = "";
            dibujarRoscos();
            actualizarUI();
        }

        function avanzarPregunta() {
            // Lógica para buscar la siguiente letra azul
            indexPregunta = (indexPregunta + 1) % 24;
            const miEstado = (miRol === 'host' || miRol === 'local') ? estadoJ1 : estadoJ2;
            let vueltas = 0;
            while(miEstado[indexPregunta] !== 'pendiente' && vueltas < 24) {
                indexPregunta = (indexPregunta + 1) % 24;
                vueltas++;
            }
        }
    </script>
</body>
</html>
