<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasapalabra Pro v4.3.0 - Security</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --fondo: #050a1f; --panel: #111b3d; --oro: #ffcc00; --verde: #2ecc71; --rojo: #dc3545; --azul: #00c6ff; }
        body { background: var(--fondo); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        .oculto { display: none !important; }

        .pantalla { text-align: center; background: var(--panel); padding: 30px; border-radius: 20px; border: 1px solid #2a3a6d; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; }
        
        .btn { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; color: white; transition: 0.3s; }
        .btn-green { background: var(--verde); }
        .btn-blue { background: var(--azul); color: #000; }
        .btn-red { background: var(--rojo); }
        .btn-face { background: linear-gradient(90deg, #00c6ff, #0072ff); border: 1px solid #fff; box-shadow: 0 0 15px var(--azul); }
        .btn-staff { background: transparent; color: #666; font-size: 0.7rem; margin-top: 15px; border: 1px solid #333; }

        input { width: 90%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; text-align: center; font-size: 1rem; background: #eee; color: #000; font-weight: bold; }

        /* C√ÅMARA Y ESC√ÅNER */
        #camara-container { width: 220px; height: 220px; margin: 10px auto; border-radius: 50%; border: 4px solid var(--verde); overflow: hidden; position: relative; background: #000; display: none; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--oro); box-shadow: 0 0 20px var(--oro); animation: escanear 1.5s infinite ease-in-out; }
        @keyframes escanear { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* PANEL FLOTANTE DENTRO DEL JUEGO */
        #hud-admin { display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); border: 1px solid var(--oro); padding: 15px; border-radius: 10px; z-index: 2000; text-align: center; min-width: 200px; }
    </style>
</head>
<body>

    <div id="hud-admin">
        <b style="color:var(--oro)">PANEL DE CONTROL</b><br>
        <span id="hud-user">---</span><br>
        <hr style="border-color:#444">
        
        <button id="btn-lock-game" class="btn oculto" style="font-size:0.7rem; padding:8px;">BLOQUEAR JUEGO</button>
        
        <button id="btn-reg-face" class="btn btn-blue" style="font-size:0.7rem; padding:8px;" onclick="registrarRostro()">üì∏ REGISTRAR CARA</button>
        
        <button class="btn" style="background:#444; font-size:0.7rem; padding:8px;" onclick="location.reload()">CERRAR SESI√ìN</button>
    </div>

    <div id="p-inicio" class="pantalla">
        <h1 style="color:var(--oro)">PASAPALABRA</h1>
        <p>Introduce tu nombre</p>
        <input type="text" id="nombre-publico" placeholder="Jugador...">
        <button class="btn btn-green" onclick="entrarPublico()">ENTRAR</button>
    </div>

    <div id="p-bloqueo" class="pantalla oculto">
        <h1 style="color:var(--rojo); font-size:3rem;">‚õî</h1>
        <h2 style="color:var(--rojo)">ACCESO CERRADO</h2>
        <p>El Superadmin ha bloqueado el juego.</p>
        <button class="btn btn-staff" onclick="pedirCodigoStaff()">ACCESO STAFF</button>
    </div>

    <div id="p-menu" class="pantalla oculto">
        <h2 id="msg-hola">HOLA</h2>
        <button class="btn btn-blue" onclick="mostrarOnline()">MODO ONLINE</button>
        <button class="btn btn-green" onclick="iniciarLocal()">MODO LOCAL</button>
        <button class="btn btn-staff" onclick="pedirCodigoStaff()">ACCESO STAFF</button>
    </div>

    <div id="p-login-staff" class="pantalla oculto">
        <h2 style="color:var(--oro)">IDENTIFICACI√ìN STAFF</h2>
        
        <div id="form-login-manual">
            <input type="text" id="st-user" placeholder="Usuario">
            <input type="password" id="st-pass" placeholder="Contrase√±a">
            <button class="btn btn-green" onclick="loginManual()">ENTRAR CON CLAVE</button>
        </div>

        <hr style="border-color:#333; margin: 15px 0;">

        <p style="font-size:0.8rem; color:#aaa;">O usa biometr√≠a si ya est√°s registrado</p>
        <button class="btn btn-face" onclick="mostrarInputFace()">üëÅÔ∏è RECONOCIMIENTO FACIAL</button>
        <button class="btn btn-staff" onclick="location.reload()">VOLVER</button>
    </div>

    <div id="p-scanner" class="pantalla oculto">
        <h3 style="color:var(--azul)">ESCANER BIOM√âTRICO</h3>
        <p id="scan-instruction">Introduce tu usuario para verificar:</p>
        <input type="text" id="face-user-input" placeholder="Ej: pablo">
        
        <div id="camara-container">
            <video id="video-feed" autoplay playsinline></video>
            <div class="scan-line"></div>
        </div>
        
        <button id="btn-iniciar-scan" class="btn btn-blue" onclick="iniciarEscaneoLogin()">INICIAR ESCANEO</button>
        <p id="scan-status" style="color:var(--oro); font-weight:bold;"></p>
        <button class="btn btn-staff" onclick="location.reload()">CANCELAR</button>
    </div>

    <div id="juego-cont" class="oculto">
        <h1 style="color:white; text-align:center; margin-top:20%;">JUEGO INICIADO</h1>
    </div>

<script>
    // --- BASE DE DATOS STAFF ---
    const CODIGO_MAESTRO = "Pablo23sek";
    const staffDB = {
        "pablo": { pass: "Pablo23sek", rango: "SUPERADMIN", super: true },
        "juliopuli": { pass: "juli26", rango: "ADMIN", super: false },
        "alvarito": { pass: "poki", rango: "VISUALIZADOR", super: false }
    };

    let sistemaBloqueado = localStorage.getItem('globalLock') === 'true';
    let usuarioActual = "";

    // --- FLUJO DE ENTRADA ---
    function entrarPublico() {
        const n = document.getElementById('nombre-publico').value;
        if(sistemaBloqueado) {
            cambiarPantalla('p-bloqueo');
        } else if (n) {
            usuarioActual = n;
            irMenu();
        }
    }

    function irMenu() {
        cambiarPantalla('p-menu');
        document.getElementById('msg-hola').innerText = "HOLA, " + usuarioActual.toUpperCase();
    }

    function pedirCodigoStaff() {
        const c = prompt("Introduce C√ìDIGO DE ACCESO:");
        if(c === CODIGO_MAESTRO) {
            cambiarPantalla('p-login-staff');
        } else if (c !== null) {
            alert("C√≥digo incorrecto");
        }
    }

    // --- LOGIN MANUAL ---
    function loginManual() {
        const u = document.getElementById('st-user').value.toLowerCase();
        const p = document.getElementById('st-pass').value;

        if (staffDB[u] && staffDB[u].pass === p) {
            accesoStaffConcedido(u);
        } else {
            alert("Credenciales incorrectas");
        }
    }

    // --- RECONOCIMIENTO FACIAL (L√ìGICA) ---
    function mostrarInputFace() {
        cambiarPantalla('p-scanner');
    }

    async function iniciarEscaneoLogin() {
        const u = document.getElementById('face-user-input').value.toLowerCase();
        const status = document.getElementById('scan-status');
        
        // 1. Verificar si existe el usuario
        if (!staffDB[u]) return alert("Usuario no existe");

        // 2. Verificar si tiene cara registrada (en localStorage)
        const tieneCara = localStorage.getItem('faceID_' + u);
        
        if (!tieneCara) {
            status.style.color = "red";
            status.innerText = "ERROR: Rostro no registrado. Entra con contrase√±a primero.";
            return;
        }

        // 3. Encender c√°mara para "verificar"
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('camara-container').style.display = "block";
            document.getElementById('video-feed').srcObject = stream;
            document.getElementById('btn-iniciar-scan').style.display = "none";
            document.getElementById('face-user-input').style.display = "none";
            document.getElementById('scan-instruction').innerText = "Analizando biometr√≠a de " + u.toUpperCase() + "...";
            
            // Simulaci√≥n de an√°lisis (3 segundos)
            status.innerText = "ESCANEANDO...";
            setTimeout(() => {
                stream.getTracks().forEach(t => t.stop()); // Apagar c√°mara
                accesoStaffConcedido(u);
            }, 3000);

        } catch (e) {
            alert("Error: No se detecta c√°mara.");
        }
    }

    // --- ACCESO Y REGISTRO ---
    function accesoStaffConcedido(user) {
        usuarioActual = user.toUpperCase();
        // Mostrar HUD
        document.getElementById('hud-admin').style.display = "block";
        document.getElementById('hud-user').innerText = usuarioActual + " (" + staffDB[user].rango + ")";
        
        // Configurar bot√≥n bloqueo (Solo Pablo)
        if(staffDB[user].super) {
            const btn = document.getElementById('btn-lock-game');
            btn.classList.remove('oculto');
            actualizarBotonBloqueo(btn);
        }

        irMenu();
    }

    // --- REGISTRAR NUEVA CARA (DENTRO DEL PANEL) ---
    async function registrarRostro() {
        const user = usuarioActual.toLowerCase();
        const conf = confirm("¬øQuieres registrar tu cara actual para el usuario " + usuarioActual + "?");
        
        if(conf) {
            // Simulamos el proceso de registro abriendo la c√°mara un momento
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                // Creamos un video temporal invisible para simular la captura
                const videoTemp = document.createElement('video');
                videoTemp.srcObject = stream;
                videoTemp.play();
                
                alert("Mira a la c√°mara... Capturando en 3 segundos.");
                
                setTimeout(() => {
                    localStorage.setItem('faceID_' + user, 'true'); // GUARDAMOS EL REGISTRO
                    stream.getTracks().forEach(t => t.stop());
                    alert("‚úÖ √âXITO: Reconocimiento facial activado para " + usuarioActual);
                    document.getElementById('btn-reg-face').style.display = "none"; // Ya no necesita registrarse
                }, 3000);
            } catch(e) {
                alert("Error de c√°mara");
            }
        }
    }

    function actualizarBotonBloqueo(btn) {
        if(sistemaBloqueado) {
            btn.innerText = "üîì DESBLOQUEAR JUEGO";
            btn.className = "btn btn-green";
            btn.onclick = () => { toggleBloqueo(false); };
        } else {
            btn.innerText = "üîí BLOQUEAR JUEGO";
            btn.className = "btn btn-red";
            btn.onclick = () => { toggleBloqueo(true); };
        }
    }

    function toggleBloqueo(estado) {
        sistemaBloqueado = estado;
        localStorage.setItem('globalLock', estado);
        alert(estado ? "JUEGO BLOQUEADO" : "JUEGO ABIERTO");
        location.reload();
    }

    // --- UTILS ---
    function cambiarPantalla(id) {
        document.querySelectorAll('.pantalla').forEach(p => p.classList.add('oculto'));
        document.getElementById(id).classList.remove('oculto');
    }

    function iniciarLocal() {
        cambiarPantalla('juego-cont'); // Placeholder
    }
    function mostrarOnline() {
         // Placeholder conexi√≥n
         alert("Abriendo modo online...");
    }
</script>
</body>
</html>
