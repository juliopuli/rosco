<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra IA - Modo Tolerante</title>
    <style>
        body { background: #050510; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        #rosco-container { position: relative; width: 420px; height: 420px; margin: 30px; }
        .letra { position: absolute; width: 34px; height: 34px; background: #0044cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; transform: translate(-50%, -50%); transition: 0.3s; font-size: 14px; }
        .activa { border: 4px solid #f1c40f; scale: 1.3; box-shadow: 0 0 20px #f1c40f; z-index: 10; }
        .acierto { background: #2ecc71 !important; box-shadow: 0 0 15px #2ecc71; }
        .fallo { background: #e74c3c !important; box-shadow: 0 0 15px #e74c3c; }
        #panel { background: #16213e; padding: 25px; border-radius: 20px; text-align: center; width: 90%; max-width: 550px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { padding: 12px; width: 80%; margin: 15px 0; border-radius: 8px; border: none; font-size: 1.1em; outline: none; background: #0a192f; color: white; border: 2px solid #1f4068; }
        button { padding: 12px 25px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; margin: 5px; }
        .btn-ok { background: #2ecc71; color: white; }
        .btn-paso { background: #f1c40f; color: #333; }
        #feedback { display: none; margin-top: 15px; padding: 15px; border-radius: 10px; font-weight: bold; }
        .msg-error { background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #ff7675; }
        .msg-fuzzy { background: rgba(241, 196, 15, 0.2); border: 1px solid #f1c40f; color: #f1c40f; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="rosco-container"></div>

    <div id="panel">
        <div style="margin-bottom:10px; opacity:0.7;">Aciertos: <span id="hits">0</span> | Fallos: <span id="miss">0</span></div>
        <h3 id="pregunta">Cargando...</h3>
        <input type="text" id="inputRespuesta" placeholder="Tu respuesta..." autocomplete="off">
        <br>
        <button class="btn-ok" onclick="validar()">RESPONDER</button>
        <button class="btn-paso" onclick="pasapalabra()">PASAPALABRA</button>
        <div id="feedback"></div>
    </div>

    <script>
        let rosco = [];
        let idx = 0;
        let aciertos = 0;
        let fallos = 0;
        let bloqueado = false;

        // Algoritmo de distancia para permitir errores
        function getDistancia(a, b) {
            const matrix = Array.from({ length: a.length + 1 }, (_, i) => [i]);
            for (let j = 1; j <= b.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= a.length; i++) {
                for (let j = 1; j <= b.length; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
                }
            }
            return matrix[a.length][b.length];
        }

        async function iniciar() {
            const res = await fetch('preguntas.json?v=' + Date.now());
            rosco = (await res.json()).map(p => ({ ...p, estado: 'pendiente' }));
            dibujarRosco();
            actualizar();
        }

        function dibujarRosco() {
            const cont = document.getElementById('rosco-container');
            rosco.forEach((p, i) => {
                const angulo = (i * (360 / rosco.length)) - 90;
                const rad = angulo * Math.PI / 180;
                const div = document.createElement('div');
                div.id = 'l-' + i;
                div.className = 'letra';
                div.style.left = (210 + 180 * Math.cos(rad)) + 'px';
                div.style.top = (210 + 180 * Math.sin(rad)) + 'px';
                div.innerText = p.letra;
                cont.appendChild(div);
            });
        }

        function actualizar() {
            if (rosco.filter(p => p.estado === 'pendiente').length === 0) {
                document.getElementById('panel').innerHTML = `<h2>Fin del Juego</h2><p>Aciertos: ${aciertos}</p><button onclick="location.reload()">Reiniciar</button>`;
                return;
            }
            while (rosco[idx].estado !== 'pendiente') idx = (idx + 1) % rosco.length;
            document.querySelectorAll('.letra').forEach(l => l.classList.remove('activa'));
            document.getElementById('l-' + idx).classList.add('activa');
            document.getElementById('pregunta').innerText = `${rosco[idx].tipo} ${rosco[idx].letra}: ${rosco[idx].pregunta}`;
            document.getElementById('feedback').style.display = 'none';
            bloqueado = false;
        }

        function validar() {
            if (bloqueado) return;
            const input = document.getElementById('inputRespuesta');
            const feedback = document.getElementById('feedback');
            
            const user = input.value.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const target = rosco[idx].respuesta.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (user === "") return;
            bloqueado = true;

            const dist = getDistancia(user, target);
            let esValida = false;

            // --- NUEVO SISTEMA DE TOLERANCIA EXTRA ---
            if (user === target) {
                esValida = true;
            } else if (target.length <= 4) {
                // Palabras muy cortas (3-4 letras): permitimos 1 fallo
                if (dist <= 1) esValida = true;
            } else if (target.length <= 7) {
                // Palabras medias (como COCHE): permitimos 1 fallo (COCE)
                if (dist <= 1) esValida = true;
            } else {
                // Palabras largas: permitimos hasta 2 fallos
                if (dist <= 2) esValida = true;
            }

            if (esValida) {
                rosco[idx].estado = 'acierto';
                document.getElementById('l-' + idx).classList.add('acierto');
                aciertos++;
                document.getElementById('hits').innerText = aciertos;
                
                if (user !== target) {
                    feedback.innerText = `¡Casi! Aceptamos "${input.value}" como "${target.toUpperCase()}"`;
                    feedback.className = "msg-fuzzy";
                    feedback.style.display = 'block';
                    setTimeout(() => { input.value = ""; actualizar(); }, 1500);
                } else {
                    input.value = "";
                    actualizar();
                }
            } else {
                rosco[idx].estado = 'fallo';
                document.getElementById('l-' + idx).classList.add('fallo');
                fallos++;
                document.getElementById('miss').innerText = fallos;
                feedback.innerHTML = `❌ La respuesta era: ${target.toUpperCase()}`;
                feedback.className = "msg-error";
                feedback.style.display = 'block';
                setTimeout(() => { input.value = ""; actualizar(); }, 2500);
            }
        }

        function pasapalabra() {
            if (bloqueado) return;
            idx = (idx + 1) % rosco.length;
            actualizar();
        }

        document.getElementById('inputRespuesta').addEventListener('keypress', e => { if(e.key === 'Enter') validar(); });
        iniciar();
    </script>
</body>
</html>
