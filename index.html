<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pasapalabra Online Sincronizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { --blue: #0044cc; --green: #2ecc71; --red: #e74c3c; --yellow: #f1c40f; --dark: #050510; --card: #16213e; }
        body { background: var(--dark); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 400px; margin-top: 50px; }
        input { padding: 12px; border-radius: 8px; width: 80%; margin: 10px 0; text-align: center; font-size: 1.1em; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; margin: 5px; }
        .btn-main { background: var(--green); color: white; width: 100%; }
        .btn-sec { background: var(--blue); color: white; width: 100%; }
        #juego { display: none; width: 100%; justify-content: space-around; margin-top: 20px; }
        .rosco-side { width: 350px; text-align: center; }
        .rosco-container { position: relative; width: 320px; height: 320px; margin: 20px auto; }
        .letra { position: absolute; width: 28px; height: 28px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid white; transform: translate(-50%, -50%); font-size: 12px; }
        .activa { border: 3px solid var(--yellow); scale: 1.3; box-shadow: 0 0 15px var(--yellow); z-index: 10; }
        .acierto { background: var(--green) !important; }
        .fallo { background: var(--red) !important; }
        #panel-central { width: 400px; background: var(--card); padding: 20px; border-radius: 15px; text-align: center; }
        .hidden { display: none !important; }
        #status-bar { font-size: 0.8em; color: var(--yellow); margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="status-bar">Estado: Desconectado</div>

    <div id="menu-inicial" class="card">
        <h1>PASAPALABRA</h1>
        <button class="btn-main" onclick="generarCodigo()">GENERAR CÓDIGO (Ser Jugador 1)</button>
        <p>— o —</p>
        <input type="text" id="input-unirse" placeholder="Pega el código aquí">
        <button class="btn-sec" onclick="unirse()">UNIRSE A PARTIDA (Ser Jugador 2)</button>
    </div>

    <div id="esperando" class="card hidden">
        <h2>Código: <span id="display-codigo" style="color:var(--yellow)">---</span></h2>
        <p>Pásalo a tu amigo y no cierres esta ventana.</p>
    </div>

    <div id="juego">
        <div class="rosco-side"><h3 id="nom-j1">JUGADOR 1</h3><div id="rosco1" class="rosco-container"></div></div>
        <div id="panel-central">
            <div id="turno-tag" style="background:grey; padding:5px; border-radius:10px; margin-bottom:10px">Esperando...</div>
            <h4 id="pregunta-txt">Preparando rosco...</h4>
            <input type="text" id="ans" placeholder="Respuesta..." autocomplete="off">
            <br>
            <button class="btn-main" onclick="responder('ok')">ENVIAR</button>
            <button class="btn-sec" onclick="responder('paso')" style="background:var(--yellow); color:black">PASAPALABRA</button>
        </div>
        <div class="rosco-side"><h3 id="nom-j2">JUGADOR 2</h3><div id="rosco2" class="rosco-container"></div></div>
    </div>

    <script>
        let client, salaID, miRol, preguntas = [];
        let miTurno = false, idxJ1 = 0, idxJ2 = 0, estJ1 = [], estJ2 = [];

        // BANCO DE PREGUNTAS DE EMERGENCIA (Por si falla el .json)
        const backup = [
            {letra:"A", pregunta:"Aeronave con alas.", respuesta:"avion", tipo:"CON LA"},
            {letra:"B", pregunta:"Mamífero marino.", respuesta:"ballena", tipo:"CON LA"},
            {letra:"C", pregunta:"Vehículo de cuatro ruedas.", respuesta:"coche", tipo:"CON LA"},
            {letra:"D", pregunta:"Cubo para jugar.", respuesta:"dado", tipo:"CON LA"},
            {letra:"E", pregunta:"Animal con trompa.", respuesta:"elefante", tipo:"CON LA"},
            {letra:"F", pregunta:"Fruto del fresal.", respuesta:"fresa", tipo:"CON LA"},
            {letra:"G", pregunta:"Animal que maúlla.", respuesta:"gato", tipo:"CON LA"},
            {letra:"H", pregunta:"Agua sólida.", respuesta:"hielo", tipo:"CON LA"},
            {letra:"I", pregunta:"Tierra rodeada de agua.", respuesta:"isla", tipo:"CON LA"},
            {letra:"J", pregunta:"Limpieza con burbujas.", respuesta:"jabon", tipo:"CON LA"},
            {letra:"L", pregunta:"Satélite terrestre.", respuesta:"luna", tipo:"CON LA"},
            {letra:"M", pregunta:"Fruta roja o verde.", respuesta:"manzana", tipo:"CON LA"},
            {letra:"N", pregunta:"Cítrico naranja.", respuesta:"naranja", tipo:"CON LA"},
            {letra:"O", pregunta:"Órgano visual.", respuesta:"ojo", tipo:"CON LA"},
            {letra:"P", pregunta:"Mejor amigo del hombre.", respuesta:"perro", tipo:"CON LA"},
            {letra:"Q", pregunta:"Producto lácteo.", respuesta:"queso", tipo:"CON LA"},
            {letra:"R", pregunta:"Mide el tiempo.", respuesta:"reloj", tipo:"CON LA"},
            {letra:"S", pregunta:"Estrella luminosa.", respuesta:"sol", tipo:"CON LA"},
            {letra:"T", pregunta:"Vehículo por raíles.", respuesta:"tren", tipo:"CON LA"},
            {letra:"U", pregunta:"Fruta de la vid.", respuesta:"uva", tipo:"CON LA"},
            {letra:"V", pregunta:"Estación de calor.", respuesta:"verano", tipo:"CON LA"},
            {letra:"X", pregunta:"Instrumento de percusión.", respuesta:"xilofono", tipo:"CON LA"},
            {letra:"Y", pregunta:"Barco de lujo.", respuesta:"yate", tipo:"CON LA"},
            {letra:"Z", pregunta:"Calzado.", respuesta:"zapato", tipo:"CON LA"}
        ];

        function log(msg) { document.getElementById('status-bar').innerText = "Estado: " + msg; }

        function generarCodigo() {
            salaID = Math.random().toString(36).substring(2, 7).toUpperCase();
            miRol = 'host'; miTurno = true;
            document.getElementById('display-codigo').innerText = salaID;
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('esperando').classList.remove('hidden');
            conectar();
        }

        function unirse() {
            salaID = document.getElementById('input-unirse').value.trim().toUpperCase();
            if(!salaID) return alert("Pon un código");
            miRol = 'guest'; miTurno = false;
            conectar();
        }

        function conectar() {
            log("Conectando...");
            const cid = "p_" + Math.random().toString(16).substr(2, 5);
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, cid);
            client.onMessageArrived = msgRecibido;
            client.connect({
                onSuccess: () => {
                    log("Conectado a sala " + salaID);
                    client.subscribe("pasa/sala/" + salaID);
                    if(miRol === 'host') {
                        // Intentar cargar JSON, si falla usar backup
                        fetch('preguntas.json').then(r => r.json()).then(d => { preguntas = d; initEstados(); })
                        .catch(() => { preguntas = backup; initEstados(); });
                    } else {
                        setTimeout(() => enviar({tipo:'JOIN'}), 1000);
                    }
                },
                useSSL: false
            });
        }

        function initEstados() {
            estJ1 = new Array(preguntas.length).fill('pendiente');
            estJ2 = new Array(preguntas.length).fill('pendiente');
        }

        function enviar(obj) {
            const m = new Paho.MQTT.Message(JSON.stringify(obj));
            m.destinationName = "pasa/sala/" + salaID;
            client.send(m);
        }

        function msgRecibido(m) {
            const d = JSON.parse(m.payloadString);
            if(d.tipo === 'JOIN' && miRol === 'host') {
                log("¡Rival entró!");
                enviar({tipo:'START', preguntas: preguntas});
                empezar();
            }
            if(d.tipo === 'START' && miRol === 'guest') {
                log("¡Partida iniciada!");
                preguntas = d.preguntas;
                initEstados();
                empezar();
            }
            if(d.tipo === 'ACCION' && d.player !== miRol) {
                if(d.player === 'host') estJ1[d.idx] = d.res; else estJ2[d.idx] = d.res;
                if(d.res !== 'acierto') miTurno = true;
                dibujar();
            }
        }

        function empezar() {
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('esperando').classList.add('hidden');
            document.getElementById('juego').style.display = 'flex';
            dibujar();
        }

        function dibujar() {
            const tag = document.getElementById('turno-tag');
            tag.innerText = miTurno ? "ES TU TURNO" : "TURNO RIVAL";
            tag.style.background = miTurno ? "var(--green)" : "var(--red)";
            
            render('rosco1', estJ1, (miRol==='host'?idxJ1:idxJ2), (miRol==='host'));
            render('rosco2', estJ2, (miRol==='host'?idxJ2:idxJ1), (miRol==='guest'));

            const pIdx = (miRol==='host'?idxJ1:idxJ2);
            document.getElementById('pregunta-txt').innerText = `${preguntas[pIdx].tipo} ${preguntas[pIdx].letra}: ${preguntas[pIdx].pregunta}`;
            document.getElementById('ans').disabled = !miTurno;
        }

        function render(id, estados, activo, esMio) {
            const c = document.getElementById(id); c.innerHTML = "";
            estados.forEach((e, i) => {
                const a = (i * (360/24)) - 90;
                const r = a * Math.PI / 180;
                const d = document.createElement('div');
                d.className = `letra ${e} ${(esMio && i===activo && miTurno) ? 'activa' : ''}`;
                d.style.left = (160 + 130 * Math.cos(r)) + 'px';
                d.style.top = (160 + 130 * Math.sin(r)) + 'px';
                d.innerText = preguntas[i].letra;
                c.appendChild(d);
            });
        }

        function responder(tipo) {
            if(!miTurno) return;
            const pIdx = (miRol==='host'?idxJ1:idxJ2);
            let res = 'pendiente';
            if(tipo === 'ok') {
                const u = document.getElementById('ans').value.toLowerCase().trim();
                const t = preguntas[pIdx].respuesta.toLowerCase();
                // Aceptamos 1 fallo de diferencia
                if(u === t || (t.length > 4 && dist(u,t) <= 1)) res = 'acierto';
                else { res = 'fallo'; miTurno = false; }
            } else { miTurno = false; }

            if(miRol === 'host') estJ1[pIdx] = res; else estJ2[pIdx] = res;
            enviar({tipo:'ACCION', player: miRol, idx: pIdx, res: res});
            if(res !== 'pendiente') {
                if(miRol==='host') { do{idxJ1=(idxJ1+1)%24}while(estJ1[idxJ1]!=='pendiente'); }
                else { do{idxJ2=(idxJ2+1)%24}while(estJ2[idxJ2]!=='pendiente'); }
            }
            document.getElementById('ans').value = "";
            dibujar();
        }

        function dist(a, b) {
            const m = Array.from({length:a.length+1},(_,i)=>[i]);
            for(let j=1;j<=b.length;j++)m[0][j]=j;
            for(let i=1;i<=a.length;i++)for(let j=1;j<=b.length;j++){
                const c = a[i-1]===b[j-1]?0:1;
                m[i][j]=Math.min(m[i-1][j]+1,m[i][j-1]+1,m[i-1][j-1]+c);
            }
            return m[a.length][b.length];
        }
    </script>
</body>
</html>
