<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasapalabra Online Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root { --blue: #0044cc; --green: #2ecc71; --red: #e74c3c; --yellow: #f1c40f; --dark: #050510; --card: #16213e; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        /* Menús */
        .card { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 450px; width: 100%; margin-top: 50px; }
        input { padding: 12px; border-radius: 8px; border: 2px solid #1f4068; background: #0a192f; color: white; width: 80%; margin: 10px 0; font-size: 1.1em; text-align: center; outline: none; }
        button { padding: 12px 20px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; margin: 5px; transition: 0.3s; text-transform: uppercase; }
        .btn-main { background: var(--green); color: white; width: 100%; }
        .btn-sec { background: var(--blue); color: white; width: 100%; }
        
        /* Layout Juego */
        #juego { display: none; width: 100%; max-width: 1200px; justify-content: space-around; align-items: flex-start; margin-top: 20px; gap: 20px; }
        .rosco-side { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .rosco-container { position: relative; width: 340px; height: 340px; margin: 20px; }
        
        /* Letras */
        .letra { position: absolute; width: 30px; height: 30px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; transform: translate(-50%, -50%); font-size: 13px; transition: 0.3s; }
        .activa { border: 4px solid var(--yellow); scale: 1.3; box-shadow: 0 0 15px var(--yellow); z-index: 10; }
        .acierto { background: var(--green) !important; box-shadow: 0 0 10px var(--green); }
        .fallo { background: var(--red) !important; box-shadow: 0 0 10px var(--red); }

        #panel-central { width: 400px; background: var(--card); padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .turno-tag { padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 15px; display: inline-block; font-size: 0.9em; }
        .mi-turno { background: var(--green); color: #050510; }
        .su-turno { background: var(--red); color: white; }
        
        #feedback { margin-top: 15px; padding: 10px; border-radius: 10px; min-height: 20px; font-weight: bold; font-size: 0.9em; }
        .hidden { display: none !important; }
        #copy-code { background: #34495e; color: #ecf0f1; padding: 15px; border-radius: 8px; cursor: pointer; font-family: monospace; font-size: 1.5em; letter-spacing: 3px; margin: 10px 0; border: 1px dashed white; }
    </style>
</head>
<body>

    <div id="menu-inicial" class="card">
        <h1>PASAPALABRA</h1>
        <button class="btn-main" onclick="iniciarModo('local')">MODO LOCAL (1 Jugador)</button>
        <button class="btn-sec" onclick="mostrarMenuOnline()">MODO ONLINE (2 Jugadores)</button>
    </div>

    <div id="menu-online" class="card hidden">
        <div id="paso-1">
            <button class="btn-main" onclick="generarCodigoPartida()">GENERAR CÓDIGO</button>
            <p style="margin: 20px 0; opacity: 0.6;">— o —</p>
            <input type="text" id="input-unirse" placeholder="PEGA EL CÓDIGO AQUÍ">
            <button class="btn-sec" onclick="unirseAPartida()">UNIRSE A PARTIDA</button>
        </div>
        
        <div id="esperando" class="hidden">
            <h3>Tu código de sala:</h3>
            <div id="copy-code" onclick="copiarCodigo()">---</div>
            <p style="font-size: 0.9em; opacity: 0.8;">Haz clic en el código para copiarlo.<br>Esperando a que el oponente se conecte...</p>
        </div>
    </div>

    <div id="juego">
        <div class="rosco-side">
            <h3 id="label-j1">JUGADOR 1 (HOST)</h3>
            <div id="rosco1" class="rosco-container"></div>
        </div>

        <div id="panel-central">
            <div id="badge-turno" class="turno-tag">CONECTANDO...</div>
            <h4 id="pregunta-txt">Cargando preguntas...</h4>
            <div id="controles">
                <input type="text" id="ans" placeholder="Escribe tu respuesta..." autocomplete="off">
                <br>
                <button class="btn-main" onclick="procesarAccion('ok')">RESPONDER</button>
                <button class="btn-sec" onclick="procesarAccion('paso')" style="background:var(--yellow); color:black">PASAPALABRA</button>
            </div>
            <div id="feedback"></div>
        </div>

        <div class="rosco-side">
            <h3 id="label-j2">JUGADOR 2 (INVITADO)</h3>
            <div id="rosco2" class="rosco-container"></div>
        </div>
    </div>

    <script>
        let client, salaID, miRol; 
        let miTurno = false;
        let preguntas = [];
        let idxJ1 = 0, idxJ2 = 0;
        let estadosJ1 = [], estadosJ2 = [];

        // Distancia Levenshtein para faltas de ortografía
        function getDistancia(a, b) {
            const m = Array.from({ length: a.length + 1 }, (_, i) => [i]);
            for (let j = 1; j <= b.length; j++) m[0][j] = j;
            for (let i = 1; i <= a.length; i++) {
                for (let j = 1; j <= b.length; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    m[i][j] = Math.min(m[i - 1][j] + 1, m[i][j - 1] + 1, m[i - 1][j - 1] + cost);
                }
            }
            return m[a.length][b.length];
        }

        // Navegación básica
        function mostrarMenuOnline() {
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('menu-online').classList.remove('hidden');
        }

        function generarCodigoPartida() {
            salaID = Math.random().toString(36).substring(2, 8).toUpperCase();
            miRol = 'host';
            miTurno = true;
            document.getElementById('copy-code').innerText = salaID;
            document.getElementById('paso-1').classList.add('hidden');
            document.getElementById('esperando').classList.remove('hidden');
            conectarMQTT();
        }

        function unirseAPartida() {
            const val = document.getElementById('input-unirse').value.trim().toUpperCase();
            if(!val) return alert("Introduce un código");
            salaID = val;
            miRol = 'guest';
            miTurno = false;
            conectarMQTT();
        }

        // MQTT Sincronización
        function conectarMQTT() {
            const cid = "pasa_" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client("broker.hivemq.com", 8000, cid);
            client.onMessageArrived = manejarMensaje;
            
            client.connect({ 
                onSuccess: () => {
                    client.subscribe("pasa/sala/" + salaID);
                    if(miRol === 'host') {
                        cargarPreguntasLocal();
                    } else {
                        setTimeout(() => enviarMsg({ tipo: 'JOIN' }), 600);
                    }
                },
                useSSL: false
            });
        }

        async function cargarPreguntasLocal() {
            const res = await fetch('preguntas.json');
            preguntas = await res.json();
            estadosJ1 = new Array(preguntas.length).fill('pendiente');
            estadosJ2 = new Array(preguntas.length).fill('pendiente');
        }

        function enviarMsg(obj) {
            const message = new Paho.MQTT.Message(JSON.stringify(obj));
            message.destinationName = "pasa/sala/" + salaID;
            client.send(message);
        }

        function manejarMensaje(msg) {
            const data = JSON.parse(msg.payloadString);
            if(data.tipo === 'JOIN' && miRol === 'host') {
                enviarMsg({ tipo: 'START', preguntas: preguntas });
                empezarJuego();
            }
            if(data.tipo === 'START' && miRol === 'guest') {
                preguntas = data.preguntas;
                estadosJ1 = new Array(preguntas.length).fill('pendiente');
                estadosJ2 = new Array(preguntas.length).fill('pendiente');
                empezarJuego();
            }
            if(data.tipo === 'ACCION') {
                if(data.player !== miRol) {
                    actualizarEstadoRival(data);
                }
            }
        }

        function empezarJuego() {
            document.getElementById('menu-online').classList.add('hidden');
            document.getElementById('menu-inicial').classList.add('hidden');
            document.getElementById('juego').style.display = 'flex';
            dibujarRoscos();
            actualizarUI();
        }

        function dibujarRoscos() {
            renderRosco('rosco1', estadosJ1, (miRol === 'host' ? idxJ1 : idxJ2), (miRol === 'host'));
            renderRosco('rosco2', estadosJ2, (miRol === 'host' ? idxJ2 : idxJ1), (miRol === 'guest'));
        }

        function renderRosco(id, estados, activoIdx, esMiRosco) {
            const cont = document.getElementById(id);
            cont.innerHTML = "";
            estados.forEach((est, i) => {
                const ang = (i * (360 / 24)) - 90;
                const rad = ang * Math.PI / 180;
                const div = document.createElement('div');
                div.className = `letra ${est} ${(esMiRosco && i === activoIdx && miTurno) || (!esMiRosco && i === activoIdx && !miTurno) ? 'activa' : ''}`;
                div.style.left = (170 + 145 * Math.cos(rad)) + 'px';
                div.style.top = (170 + 145 * Math.sin(rad)) + 'px';
                div.innerText = preguntas[i].letra;
                cont.appendChild(div);
            });
        }

        function actualizarUI() {
            const badge = document.getElementById('badge-turno');
            badge.innerText = miTurno ? "ES TU TURNO" : "TURNO DEL RIVAL";
            badge.className = "turno-tag " + (miTurno ? "mi-turno" : "su-turno");
            
            const pIdx = (miRol === 'host' ? idxJ1 : idxJ2);
            const p = preguntas[pIdx];
            document.getElementById('pregunta-txt').innerText = `${p.tipo} ${p.letra}: ${p.pregunta}`;
            document.getElementById('controles').style.opacity = miTurno ? "1" : "0.3";
            document.getElementById('ans').disabled = !miTurno;
            if(miTurno) document.getElementById('ans').focus();
        }

        function procesarAccion(tipo) {
            if(!miTurno) return;
            const input = document.getElementById('ans');
            const feedback = document.getElementById('feedback');
            const pIdx = (miRol === 'host' ? idxJ1 : idxJ2);
            let res = 'pendiente';

            if(tipo === 'ok') {
                const user = input.value.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const target = preguntas[pIdx].respuesta.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if(!user) return;

                const dist = getDistancia(user, target);
                // TOLERANCIA ALTA: Aceptamos 1 fallo en palabras de hasta 6 letras, 2 en más largas
                let esValida = (user === target) || (target.length <= 6 && dist <= 1) || (target.length > 6 && dist <= 2);

                if(esValida) {
                    res = 'acierto';
                    feedback.innerText = "¡CORRECTO!";
                    feedback.style.color = "var(--green)";
                } else {
                    res = 'fallo';
                    feedback.innerText = "¡FALLO! Era: " + target.toUpperCase();
                    feedback.style.color = "var(--red)";
                    miTurno = false;
                }
            } else {
                miTurno = false;
                feedback.innerText = "PASAPALABRA...";
                feedback.style.color = "var(--yellow)";
            }

            if(miRol === 'host') estadosJ1[pIdx] = res;
            else estadosJ2[pIdx] = res;

            enviarMsg({ tipo: 'ACCION', player: miRol, idx: pIdx, res: res });
            
            setTimeout(() => {
                if(res !== 'pendiente') avanzarIdx();
                input.value = "";
                feedback.innerText = "";
                dibujarRoscos();
                actualizarUI();
            }, res === 'pendiente' ? 0 : 1500);
        }

        function actualizarEstadoRival(data) {
            if(data.player === 'host') estadosJ1[data.idx] = data.res;
            else estadosJ2[data.idx] = data.res;
            
            if(data.res !== 'acierto') {
                miTurno = true;
                document.getElementById('feedback').innerText = "¡ES TU TURNO!";
            }
            dibujarRoscos();
            actualizarUI();
        }

        function avanzarIdx() {
            if(miRol === 'host') {
                do { idxJ1 = (idxJ1 + 1) % 24; } while(estadosJ1[idxJ1] !== 'pendiente' && estadosJ1.includes('pendiente'));
            } else {
                do { idxJ2 = (idxJ2 + 1) % 24; } while(estadosJ2[idxJ2] !== 'pendiente' && estadosJ2.includes('pendiente'));
            }
        }

        function copiarCodigo() {
            navigator.clipboard.writeText(salaID);
            alert("Código copiado al portapapeles: " + salaID);
        }

        // Modo Local (por si quieres jugar solo)
        function iniciarModo(modo) {
            if(modo === 'local') {
                miRol = 'host';
                miTurno = true;
                salaID = "LOCAL";
                cargarPreguntasLocal().then(() => empezarJuego());
            }
        }
        
        document.getElementById('ans').addEventListener('keypress', e => { if(e.key === 'Enter') procesarAccion('ok'); });
    </script>
</body>
</html>
